# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ—Ä–≥–æ–≤–ª–µ–π

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ú–Ω–æ–≥–æ BUY —Å–¥–µ–ª–æ–∫ –ø–æ–¥—Ä—è–¥ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

**–ß—Ç–æ –≤–∏–¥–Ω–æ:**
- 11 BUY —Å–¥–µ–ª–æ–∫ –¥–ª—è BTCUSDT –ø–æ–¥—Ä—è–¥ (03:30 - 04:25)
- –í—Å–µ —Å–¥–µ–ª–∫–∏ FILLED
- –ù–µ—Ç SELL —Å–¥–µ–ª–æ–∫ –º–µ–∂–¥—É –Ω–∏–º–∏

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í—Å–µ BUY —Å–¥–µ–ª–∫–∏ –∏–º–µ—é—Ç `closed_at = 2026-01-13 19:04:42` (—Å—Ç—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤ –ø—Ä–æ—à–ª–æ–º!)
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ `getNetPosition()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 (—Ç.–∫. `whereNull('closed_at')`)
- –ë–æ—Ç –¥—É–º–∞–µ—Ç, —á—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç, –∏ —Å–Ω–æ–≤–∞ –ø–æ–∫—É–ø–∞–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** `closed_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫!

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: BUY —Å–¥–µ–ª–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç PNL –±–µ–∑ SELL

**–ß—Ç–æ –≤–∏–¥–Ω–æ:**
- –í—Å–µ BUY —Å–¥–µ–ª–∫–∏ –∏–º–µ—é—Ç `realized_pnl` –æ–∫–æ–ª–æ 0.25-0.26 USDT
- –ù–æ –Ω–µ—Ç SELL —Å–¥–µ–ª–æ–∫ –¥–ª—è —ç—Ç–∏—Ö BUY —Å–¥–µ–ª–æ–∫
- `closed_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö SELL –æ—Ä–¥–µ—Ä–æ–≤

**–ü—Ä–∏—á–∏–Ω–∞:**
- `realized_pnl` –∏ `closed_at` –±—ã–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏)
- PnL –¥–æ–ª–∂–µ–Ω —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å SELL —Å–¥–µ–ª–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** PnL —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ—Ç SELL —Å–¥–µ–ª–æ–∫

**–ß—Ç–æ –≤–∏–¥–Ω–æ:**
- –ú–Ω–æ–≥–æ BUY —Å–¥–µ–ª–æ–∫, –Ω–æ –Ω–µ—Ç SELL —Å–¥–µ–ª–æ–∫ –¥–ª—è BTCUSDT
- –¢–æ–ª—å–∫–æ 2 —Å–¥–µ–ª–∫–∏ BNBUSDT (1 BUY, 1 SELL)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –°–∏–≥–Ω–∞–ª SELL –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è (RSI –Ω–µ > 60 –∏–ª–∏ —Ü–µ–Ω–∞ –Ω–µ < EMA)
2. `canSell()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false (–Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π, —Ç.–∫. –µ—Å—Ç—å BUY —Å–¥–µ–ª–∫–∏)
3. SELL —Å–¥–µ–ª–∫–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∞–µ—Ç, –Ω–æ –Ω–µ –ø—Ä–æ–¥–∞–µ—Ç!

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É `closed_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ BUY —Å–¥–µ–ª–∫–∏ —Å closed_at
SELECT id, side, symbol, created_at, closed_at, realized_pnl, status
FROM trades
WHERE side = 'BUY' AND closed_at IS NOT NULL
ORDER BY id DESC
LIMIT 20;
```

**–í–æ–ø—Ä–æ—Å:** –û—Ç–∫—É–¥–∞ –≤–∑—è–ª—Å—è `closed_at = 2026-01-13 19:04:42` –¥–ª—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫?

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SELL —Å–¥–µ–ª–∫–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ SELL —Å–¥–µ–ª–∫–∏
SELECT id, side, symbol, parent_id, created_at, status
FROM trades
WHERE side = 'SELL'
ORDER BY id DESC;
```

**–í–æ–ø—Ä–æ—Å:** –ï—Å—Ç—å –ª–∏ SELL —Å–¥–µ–ª–∫–∏ –¥–ª—è BTCUSDT?

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
SELECT id, side, symbol, quantity, price, status, closed_at
FROM trades
WHERE side = 'BUY' 
  AND status = 'FILLED' 
  AND closed_at IS NULL
ORDER BY id DESC;
```

**–í–æ–ø—Ä–æ—Å:** –°–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å–µ–π—á–∞—Å?

---

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å `closed_at` –¥–ª—è –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π

–ï—Å–ª–∏ BUY —Å–¥–µ–ª–∫–∏ –Ω–µ –∑–∞–∫—Ä—ã—Ç—ã (–Ω–µ—Ç SELL), –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å `closed_at`:

```sql
-- –£–±—Ä–∞—Ç—å closed_at –¥–ª—è BUY —Å–¥–µ–ª–æ–∫, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç SELL
UPDATE trades t1
SET closed_at = NULL, realized_pnl = NULL
WHERE t1.side = 'BUY'
  AND t1.closed_at IS NOT NULL
  AND NOT EXISTS (
    SELECT 1 FROM trades t2
    WHERE t2.parent_id = t1.id
      AND t2.side = 'SELL'
      AND t2.status = 'FILLED'
  );
```

### –†–µ—à–µ–Ω–∏–µ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É SELL

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è SELL —Å–∏–≥–Ω–∞–ª—ã:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RSI –∏ EMA –∑–Ω–∞—á–µ–Ω–∏—è:**
   - RSI –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 60 –¥–ª—è SELL
   - –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å < EMA (–∏–ª–∏ –±–ª–∏–∑–∫–æ –∫ EMA —Å –¥–æ–ø—É—Å–∫–æ–º 1%)

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å `canSell()`:**
   - –î–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `true`, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ BUY –ø–æ–∑–∏—Ü–∏–∏

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SELL —Å–∏–≥–Ω–∞–ª—ã

### –†–µ—à–µ–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Stop-Loss / Take-Profit

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ª–∏ Stop-Loss / Take-Profit:

- Stop-Loss: 3% –¥–ª—è BTCUSDT
- Take-Profit: 6% –¥–ª—è BTCUSDT

–ï—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —ç—Ç–∏—Ö —É—Ä–æ–≤–Ω–µ–π, SELL –Ω–µ –±—É–¥–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## üö® –°—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

```sql
-- –£–±—Ä–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π closed_at
UPDATE trades
SET closed_at = NULL, realized_pnl = NULL
WHERE side = 'BUY'
  AND closed_at = '2026-01-13 19:04:42'
  AND NOT EXISTS (
    SELECT 1 FROM trades t2
    WHERE t2.parent_id = trades.id
      AND t2.side = 'SELL'
      AND t2.status = 'FILLED'
  );
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é

```bash
php artisan balance:check BTC --exchange=okx
```

–°—Ä–∞–≤–Ω–∏—Ç—å —Å `getNetPosition()` –≤ –ë–î.

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–æ–≤
tail -f storage/logs/laravel.log | grep "Trading bot decision"
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ª–∏ SELL —Å–∏–≥–Ω–∞–ª—ã?
- –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `canSell()`?
- –ü–æ—á–µ–º—É SELL —Å–¥–µ–ª–∫–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è?

---

## üìä –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:

1. **BUY —Å–∏–≥–Ω–∞–ª:**
   - –°–æ–∑–¥–∞–µ—Ç—Å—è BUY —Å–¥–µ–ª–∫–∞
   - `closed_at = NULL`
   - `realized_pnl = NULL`

2. **SELL —Å–∏–≥–Ω–∞–ª (–∏–ª–∏ Stop-Loss/Take-Profit):**
   - –°–æ–∑–¥–∞–µ—Ç—Å—è SELL —Å–¥–µ–ª–∫–∞
   - `parent_id` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ BUY
   - –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
     - BUY: `closed_at` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
     - BUY: `realized_pnl` —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

3. **–ü–æ–∑–∏—Ü–∏—è:**
   - `getNetPosition()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö BUY –ø–æ–∑–∏—Ü–∏–π
   - `canBuy()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è = 0
   - `canSell()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è > 0

---

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

1. **–ö–æ–≥–¥–∞ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `closed_at = 2026-01-13 19:04:42`?**
   - –í—Ä—É—á–Ω—É—é?
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?
   - –ò–∑-–∑–∞ –æ—à–∏–±–∫–∏?

2. **–ü–æ—á–µ–º—É –Ω–µ—Ç SELL —Å–¥–µ–ª–æ–∫?**
   - –°–∏–≥–Ω–∞–ª SELL –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è?
   - SELL —Å–¥–µ–ª–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è?
   - –ï—Å—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ SELL?

3. **–ü–æ—á–µ–º—É –±–æ—Ç –ø–æ–∫—É–ø–∞–µ—Ç —Ç–∞–∫ —á–∞—Å—Ç–æ?**
   - –°–∏–≥–Ω–∞–ª BUY –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç?
   - `canBuy()` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`?

---

## üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `closed_at` –≤ –ë–î
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ SELL —Å–∏–≥–Ω–∞–ª–æ–≤
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
4. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SELL —Å–∏–≥–Ω–∞–ª—ã
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ SELL —Å–¥–µ–ª–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è
