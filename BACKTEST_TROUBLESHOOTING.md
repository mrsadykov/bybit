# Устранение проблем с бэктестингом

## Проблема: Очень мало сделок (1-3 за 1000 свечей)

### Возможные причины:

1. **Пороги RSI все еще слишком строгие**
   - Текущие: 45/55
   - Проблема: Даже 45/55 дают мало сигналов на 1h
   - Решение: Попробовать 50/50 или даже изменить логику

2. **Проблема с получением данных**
   - Возможно, данные не получаются полностью
   - Возможно, формат данных неправильный
   - Решение: Проверить количество полученных свечей

3. **Стратегия не подходит для текущих условий**
   - RSI+EMA может не работать на боковом тренде
   - Решение: Попробовать другие таймфреймы или стратегии

---

## Диагностика

### Шаг 1: Проверить количество полученных свечей

Добавьте отладочный вывод в `BacktestStrategyCommand.php`:

```php
// После получения данных
if (!$jsonMode) {
    $this->info("Получено " . count($candleList) . " свечей (Fetched " . count($candleList) . " candles)");
    $this->line("Первая свеча: " . date('Y-m-d H:i:s', $candleList[0]['timestamp'] / 1000));
    $this->line("Последняя свеча: " . date('Y-m-d H:i:s', end($candleList)['timestamp'] / 1000));
}
```

### Шаг 2: Проверить значения RSI

Добавьте вывод значений RSI в процессе бэктестинга:

```php
// В runBacktest, после расчета RSI
if ($i % 50 == 0) { // Каждые 50 свечей
    $this->line("Candle {$i}: RSI = " . round($rsi, 2) . ", EMA = " . round($ema, 2) . ", Price = " . round($currentPrice, 2));
}
```

### Шаг 3: Проверить логику сигналов

Добавьте вывод всех сигналов:

```php
// После получения сигнала
if ($signal !== 'HOLD') {
    $this->line("Signal: {$signal} at candle {$i}, RSI = " . round($rsi, 2) . ", Price = " . round($currentPrice, 2));
}
```

---

## Решения

### Решение 1: Еще более мягкие пороги (50/50)

Обновлено в коде - теперь используется 50/50.

**Проблема:** Это может дать слишком много ложных сигналов.

**Тест:**
```bash
php artisan strategy:backtest BTCUSDT --timeframe=1h --exchange=okx \
  --period=1000 --rsi-period=17 --ema-period=10 \
  --rsi-buy-threshold=50 --rsi-sell-threshold=50 \
  --position-size=5 --stop-loss=3 --take-profit=6 --json
```

### Решение 2: Изменить логику стратегии

Вместо строгих условий RSI, использовать более гибкую логику:

```php
// Текущая логика:
if ($rsi < 50 && $currentPrice > $ema) return 'BUY';
if ($rsi > 50 && $currentPrice < $ema) return 'SELL';

// Альтернатива 1: Убрать условие EMA
if ($rsi < 50) return 'BUY';
if ($rsi > 50) return 'SELL';

// Альтернатива 2: Использовать разницу от 50
$rsiDiff = $rsi - 50;
if ($rsiDiff < -5 && $currentPrice > $ema) return 'BUY';  // RSI < 45
if ($rsiDiff > 5 && $currentPrice < $ema) return 'SELL';  // RSI > 55
```

### Решение 3: Попробовать другие таймфреймы

```bash
# 15m - больше сигналов
php artisan strategy:backtest BTCUSDT --timeframe=15m --exchange=okx \
  --period=1000 --rsi-period=17 --ema-period=10 \
  --rsi-buy-threshold=45 --rsi-sell-threshold=55 \
  --position-size=5 --stop-loss=3 --take-profit=6 --json

# 4h - более надежные сигналы
php artisan strategy:backtest BTCUSDT --timeframe=4h --exchange=okx \
  --period=500 --rsi-period=17 --ema-period=10 \
  --rsi-buy-threshold=40 --rsi-sell-threshold=60 \
  --position-size=5 --stop-loss=3 --take-profit=6 --json
```

### Решение 4: Проверить данные вручную

```bash
# Проверить, сколько свечей получается
curl "https://www.okx.com/api/v5/market/candles?instId=BTC-USDT&bar=1H&limit=1000" | jq '.data | length'
```

---

## Рекомендации

1. **Сначала проверьте данные:**
   - Убедитесь, что получается 1000 свечей
   - Проверьте диапазон дат (должно быть ~40 дней для 1h)

2. **Попробуйте пороги 50/50:**
   - Это даст максимальное количество сделок
   - Если все еще мало сделок - проблема в данных или логике

3. **Если пороги 50/50 дают много сделок, но плохие результаты:**
   - Вернитесь к более строгим порогам (40/60)
   - Попробуйте оптимизировать другие параметры (RSI period, EMA period)

4. **Рассмотрите альтернативные стратегии:**
   - MACD + EMA
   - Bollinger Bands
   - Moving Average Crossover

---

## Следующие шаги

1. ✅ Обновить код на проде (пороги 50/50)
2. ✅ Запустить бэктестинг с порогами 50/50
3. ✅ Проверить количество сделок
4. ✅ Если все еще мало - проверить данные и логику
5. ✅ Если много сделок, но плохие результаты - оптимизировать параметры

---

## Важно

**Пороги 50/50 очень агрессивны** и могут дать много ложных сигналов. Используйте их только для тестирования, чтобы понять, получаются ли данные правильно.

Для реальной торговли лучше использовать более консервативные пороги (40/60 или 35/65).
