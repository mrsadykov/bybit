# Обзор .env и идеи для улучшения прибыли

## 1. Краткий обзор твоего .env (фрагмент)

| Переменная | Значение | Комментарий |
|------------|----------|-------------|
| TRADING_ALERT_DAILY_LOSS_USDT | 10 | Алерт в Telegram при дневном убытке ≥ 10 USDT |
| TRADING_ALERT_LOSING_STREAK | 3 | Алерт при 3+ убыточных сделках подряд |
| TRADING_ALERT_TARGET_PROFIT_USDT | 50 | Алерт при суммарной прибыли ≥ 50 USDT |
| TRADING_MAX_OPEN_POSITIONS_TOTAL | 5 | Не более 5 открытых позиций суммарно по споту |
| TRADING_EMA_TOLERANCE_PERCENT | 1 | Допуск цены к EMA для BUY (консервативно) |
| TRADING_EMA_TOLERANCE_DEEP_PERCENT | 3 | При RSI &lt; 25 — больший допуск (больше входов в перепроданности) |
| TRADING_RSI_DEEP_OVERSOLD | 25 | Порог «глубокой перепроданности» |
| FUTURES_ENABLED | true | Фьючерсы включены |
| FUTURES_MAX_LEVERAGE_DEFAULT | 3 | Макс. плечо по умолчанию для новых ботов |
| FUTURES_DRY_RUN_DEFAULT | true | Новые фьючерсные боты по умолчанию в симуляции |
| BTC_QUOTE_ENABLED | true | Боты за BTC включены |
| BTC_QUOTE_ALERT_DAILY_LOSS_BTC | 0.001 | Алерт при дневном убытке по btc-quote ≥ 0.001 BTC |
| TRADING_POSITION_SIZE_MULTIPLIER | 0.5 | Половинный размер позиции по всем ботам |
| TRADING_STOP_LOSS_PERCENT_OVERRIDE | 3 | **Глобальный SL 3%** — подменяет SL из бота для всех спот-ботов (оставь пустым, чтобы использовать SL из БД по каждому боту). |
| TRADING_CONSERVATIVE_RSI | false | RSI из БД (38/62, 45/55) применяются |
| TRADING_MIN_MINUTES_BETWEEN_OPENS | 60 | Не чаще одного открытия в час по одному боту |
| TRADING_PAUSE_NEW_OPENS_DAILY_LOSS_USDT | 15 | Пауза новых BUY при дневном убытке ≥ **15** USDT (в комментарии было 10 — сейчас 15) |
| HEALTH_LAST_RUN_MAX_MINUTES | 15 | Health check: алерт, если последний запуск старше 15 мин |
| HEALTH_ALERT_COOLDOWN_MINUTES | 60 | Не слать повторные health-алерты чаще раза в час |
| TRADING_TRAILING_STOP_PERCENT | 2 | Трейлинг-стоп: закрытие при откате 2% от макс. с момента входа |
| TRADING_TRAILING_STOP_ACTIVATION_PERCENT | 1 | Начать отслеживать макс. после роста на 1% от входа |
| TRADING_TREND_FILTER_ENABLED | true | Фильтр тренда: BUY только если цена выше длинной EMA (или в допуске) |
| TRADING_TREND_FILTER_EMA_PERIOD | 50 | Период длинной EMA для фильтра тренда |
| TRADING_TREND_FILTER_TOLERANCE_PERCENT | 0.5 | Допуск 0.5% ниже EMA — больше входов |
| TRADING_VOLUME_FILTER_* | закомментированы | Объёмный фильтр выключен — включён только тренд (правильно) |

| TRADING_SKIP_BUY_FIRST_MINUTES / TRADING_SKIP_BUY_LAST_MINUTES | 5 / 5 | Временной фильтр: не открывать BUY в первые и последние 5 минут свечи. |

**Итог по .env:** Всё согласовано с конфигом. Риск ограничен: множитель 0.5, глобальный SL 3%, пауза при убытке 15 USDT, трейлинг, тренд-фильтр с допуском, временной фильтр 5/5 мин. Если хочешь паузу при 10 USDT — поставь `TRADING_PAUSE_NEW_OPENS_DAILY_LOSS_USDT=10`.

---

## 2. trading_bots (11).sql — проверка

- **Колонки:** совпадают со схемой таблицы `trading_bots`.
- **Строки:** 5 ботов:
  - 1: BTCUSDT 1h, RSI 38/62, MACD=1, SL 3% (фактически 2% из override), TP 6%.
  - 2: ETHUSDT 1h, RSI 38/62, MACD=0.
  - 3: SOLUSDT 1h, RSI 38/62, MACD=1, SL 6% (override 2%), TP 12%.
  - 4: BNBUSDT 1h, RSI 45/55, MACD=0.
  - **5: ETHUSDT 4h** — новый бот для эксперимента на 4h; параметры как у бота 2 (ETH 1h), кроме timeframe.

Два бота по ETHUSDT (1h и 4h) — осознанно для сравнения таймфреймов. Замечаний по данным нет.

---

## 3. Как ещё улучшить прибыль (следующие шаги)

Уже сделано: консервативный RSI выключен, множитель 0.5, тренд-фильтр с допуском, MACD на части ботов, 4h по ETH, фьючерсы, алерты, лимиты. Ниже — что можно добавить или проверить.

### A. Снять или ослабить глобальный SL — **ШАГ 1 (сделать сейчас)**

- Сейчас **TRADING_STOP_LOSS_PERCENT_OVERRIDE=2** подменяет все SL из ботов (3%, 5%, 6%) на 2%.
- **Что сделать:** в `.env` закомментировать или удалить строку:
  ```env
  # TRADING_STOP_LOSS_PERCENT_OVERRIDE=2
  ```
  Либо ослабить до 3%:
  ```env
  TRADING_STOP_LOSS_PERCENT_OVERRIDE=3
  ```
- После правки: `php artisan config:clear`. Тогда для спота будет использоваться SL из БД по каждому боту (3% для BTC/ETH, 6% для SOL, 5% для BNB).
- Через 1–2 недели можно сравнить число сделок и PnL: при 2% стопы срабатывают чаще, при SL из БД — реже, больше шансов дойти до TP.

### B. Перебор SL/TP в оптимизации (сделано)

- В команду **strategy:optimize-all** добавлена опция **--sl-tp-grid**.
- Запуск: `php artisan strategy:optimize-all --period=1500 --sl-tp-grid`
- Перебираются пары SL/TP: 2/4, 3/6, 4/8, 5/10% в дополнение к RSI. В выводе — лучшие RSI и SL/TP по символу; значения можно вручную выставить в дашборде по каждому боту.

### C. Временной фильтр (сделано)

- В конфиг добавлены опции: **TRADING_SKIP_BUY_FIRST_MINUTES** и **TRADING_SKIP_BUY_LAST_MINUTES** (в .env).
- Пример: `TRADING_SKIP_BUY_FIRST_MINUTES=5` и `TRADING_SKIP_BUY_LAST_MINUTES=5` — не открывать BUY в первые 5 и последние 5 минут свечи (для 1h это минуты 0–4 и 55–59).
- Учитывается таймфрейм бота (1h, 4h, 15m, 5m, 1D). Оставь пусто/не задавай — фильтр выключен.

### D. Постепенно поднимать множитель

- После 2–4 недель стабильной работы без просадок можно осторожно поднять `TRADING_POSITION_SIZE_MULTIPLIER` с 0.5 до 0.6–0.7, затем при желании до 1.0. Не прыгать сразу до 1.0.

### E. Частичное закрытие по TP (на потом)

- Идея: на первом уровне TP закрывать часть позиции (например 50%), остальное держать под трейлинг или второй TP. Увеличивает шанс «зафиксировать прибыль» и при этом оставить часть в движении. Требует доработки: учёт частичных SELL в PositionManager и флаг по сделке (partial_tp_done).

### F. Регулярный бэктест и оптимизация

- Раз в 2–4 недели: `php artisan strategy:backtest-all-bots --period=1500` и `php artisan strategy:optimize-all --period=1500`, затем при необходимости `strategy:apply-optimize`. Следить, чтобы при включённом тренд-фильтре число сделок в бэктесте не было нулевым.

### G. Отключить худшие пары по истории по истории

- По результатам `strategy:backtest-all-bots` временно выключить (is_active=0) бота по паре с наибольшим минусом или наименьшим числом сделок, перепроверить через 1–2 недели.

### H. Фьючерсы в реале (когда готов) (когда готов)

- После периода в dry_run при желании включить реал по одному символу с небольшим `position_size_usdt` и лимитами `max_daily_loss_usdt` / `max_losing_streak`. Не включать все пары сразу.

---

**Итог:** .env настроен разумно; дамп trading_bots (11) корректен, добавлен 4h-бот по ETH. Для дальнейшего роста прибыли: опционально поиграть с override SL, постепенно поднимать множитель, добавить в код перебор SL/TP и (при желании) частичное закрытие по TP и временной фильтр; плюс регулярный бэктест и отключение худших пар по результатам.

---

## 4. Что делать после `strategy:optimize-all --sl-tp-grid`

По выводу команды «ЛУЧШИЕ RSI + SL/TP ПО СИМВОЛУ» (на данном периоде все варианты дали минус — выбраны наименее убыточные):

| Символ   | RSI   | SL/TP | Действие в дашборде |
|----------|--------|-------|----------------------|
| BTCUSDT  | 38/62  | 4%/8% | Выставить SL 4%, TP 8% (при override=3 в .env для спота будет 3% SL; чтобы использовать 4%, закомментируй `TRADING_STOP_LOSS_PERCENT_OVERRIDE`). |
| ETHUSDT 1h | 38/62 | 2%/4% | Выставить SL 2%, TP 4% (если оставишь override=3 — SL будет 3%, TP задай 4%). |
| SOLUSDT  | 38/62  | 2%/4% | Худший результат (Win 0%, минус). Варианты: выставить SL 2%, TP 4% **или** временно отключить бота (is_active=0) / уменьшить position_size. |
| BNBUSDT  | 40/60  | 2%/4% | Выставить RSI 40/60 (если ещё не стоит), SL 2%, TP 4%. |
| ETHUSDT 4h | по таблице лучший 45/55, 5/10 | Выставить RSI 45/55, SL 5%, TP 10% для бота с таймфреймом 4h. |

**Пошагово:**

1. **RSI** — при необходимости применить разом: `php artisan strategy:apply-optimize` (проставляет 38/62 для BTC/ETH/SOL, 45/55 для BNB; для ETH 4h лучше вручную поставить 45/55 в дашборде).
2. **SL/TP** — в дашборде для каждого спот-бота вручную задать Stop-Loss и Take-Profit из таблицы выше. Команда `strategy:apply-optimize` SL/TP не меняет.
3. **Override SL** — сейчас у тебя `TRADING_STOP_LOSS_PERCENT_OVERRIDE=3`, то есть для всех спот-ботов используется 3% независимо от БД. Если хочешь разные SL по символам (2% для ETH/BNB, 4% для BTC) — закомментируй в .env строку `TRADING_STOP_LOSS_PERCENT_OVERRIDE=3` и выполни `php artisan config:clear`, затем выстави SL в дашборде по таблице.
4. **SOL** — по бэктесту SOL даёт наибольший минус и 0% win при «лучшей» комбинации. Имеет смысл либо отключить бота (is_active=0), либо уменьшить ему position_size и следить 1–2 недели.
5. **Через 1–2 недели** — посмотреть реальные сделки и PnL; при желании повторить `strategy:optimize-all --sl-tp-grid --period=1500` и подкорректировать RSI/SL/TP.
6. **Раз в 2–4 недели** — повторять оптимизацию и при необходимости обновлять параметры в дашборде.

---

## 5. Можно ли гарантировать прибыль?

**Кратко: нет.** На финансовых рынках гарантированной прибыли от автоматической торговли не бывает: прошлая доходность не обещает будущей, рынок меняется, просадки неизбежны.

Что **реально можно сделать** — повысить шансы на прибыль и жёстко ограничить убытки:

| Что делать | Зачем |
|------------|--------|
| **Не ослаблять риск-лимиты** | Множитель 0.5, max_daily_loss, max_losing_streak, пауза при дневном убытке, лимит открытых позиций — оставить. Снижение риска важнее погони за «гарантией». |
| **Не увеличивать размер позиции резко** | Поднимать множитель или position_size только после нескольких недель стабильной работы и только пошагово (0.5 → 0.6 → 0.7). |
| **Держать SL/TP из оптимизации** | У тебя уже выставлены 4/8, 2/4, 5/10 по символам — не ослаблять SL и не задирать TP без повторного бэктеста. |
| **Отключить или урезать худшие пары** | SOL уже выключен — по бэктесту давал наибольший минус. При появлении новых убыточных символов — временно отключать или уменьшать position_size. |
| **Регулярно перезапускать оптимизацию** | Раз в 2–4 недели: `strategy:optimize-all --sl-tp-grid --period=1500` и при необходимости подстраивать RSI/SL/TP под свежие данные. |
| **Не торговать на последние деньги** | Использовать только тот капитал, потерю которого можешь пережить. Это не «гарантия» прибыли, но гарантия того, что одна серия убытков не сломает счёт. |
| **Следить за алертами и дашбордом** | При срабатывании лимитов (дневной убыток, серия убытков) — реагировать: пауза уже встроена, при необходимости вручную отключить часть ботов. |

**Итог:** гарантировать прибыль нельзя; можно максимизировать дисциплину риска и согласованность с бэктестом — так ты улучшаешь ожидаемый результат и ограничиваешь просадки, а не «обещаешь» плюс.
