# Традиционный анализ торговой системы (Traditional Analysis Report)

**Дата (Date):** 2026-01-29  
**Источники (Sources):** Telegram, OKX Order/Trade History, `trades` (DB), скриншот портфеля OKX, бэктест `strategy:backtest-all`.

---

## 1. Согласованность данных (Data consistency)

### 1.1 Telegram ↔ логика ботов

| Событие | Ожидание | Факт | Вердикт |
|--------|----------|------|---------|
| Запуск | 4 активных бота | 4 активных бота | ✅ |
| BTCUSDT | HOLD, RSI 41.73 | Нет позиции, сигнал HOLD | ✅ |
| ETHUSDT | BUY при RSI &lt; 40, цена &gt; EMA | BUY 5 USDT @ 2957.68 | ✅ |
| SOLUSDT | HOLD, RSI 36.01 | Есть открытая позиция (BUY #87), HOLD | ✅ |
| BNBUSDT | HOLD, RSI 51.45 | Нет открытой позиции, HOLD | ✅ |

Сигналы и действия по парам соответствуют описанной логике RSI+EMA.

### 1.2 Двойное «ORDER FILLED» по ETHUSDT

В Telegram приходят **два** сообщения «ОРДЕР ИСПОЛНЕН» для одного BUY ETHUSDT:
- 0.00169 @ $2957.68  
- 0.00169 @ $2957.28  

**Причина:**  
- Первое — из `bots:run`: сразу после `getOrder` → FILLED, уведомление с ценой размещения (`trade->price`).  
- Второе — из `orders:sync`: синк видит ордер на бирже, обновляет цену на фактическую (avg), т.к. `|price - executedPrice| > 0.01` → `needsUpdate` → снова `notifyFilled`.

**Исправлено:**  
В `SyncOrdersCommand` `notifyFilled` вызывается только при переходе статуса **в** FILLED (`$wasNotFilled`). Если ордер уже FILLED в БД (например, после `bots:run`), sync лишь обновляет цену/объём и не шлёт повторное уведомление.

### 1.3 БД `trades` ↔ OKX

- Сделки по `order_id` совпадают с OKX Order History и Trade Details (даты, объёмы, цены, пары).  
- В БД есть последние BUY: **#87** SOLUSDT, **#88** BTCUSDT, **#89** ETHUSDT (2026-01-29). В экспорте OKX отчёт до 2026-01-28, поэтому ордер ETH 3260142049872781312 в CSV отсутствует — это ограничение выгрузки, а не расхождение.

**Вывод:** БД и OKX согласованы в пределах имеющихся выгрузок.

### 1.4 Портфель OKX (скриншот) ↔ позиции бота

| Актив | OKX (скрин) | Позиции бота (БД) | Комментарий |
|-------|-------------|-------------------|-------------|
| USDT | 105.26 | — | Ожидаемо |
| BTC | 0.00017112 | BUY #88: 0.00011360 | Остаток ≈ старый dust + новая покупка |
| SOL | 0.08029959 | BUY #87: 0.080379 | Небольшая разница, допустимо (округление, комиссия в SOL) |
| ETH | 0.00168871 | BUY #89: 0.00169 | Совпадает |
| BNB | ~0.00000071 | Нет открытой позиции | Dust |

Итого: балансы и открытые позиции бота согласуются с портфелем на скриншоте.

---

## 2. Логика и поведение (Logic & behavior)

### 2.1 Корректно

- Разделение BUY / SELL / HOLD по RSI и EMA.  
- Проверка «позиция уже открыта» — не дублируются BUY.  
- Проверка минимального размера для SELL (`passesMinSell`) — нет повторных ошибок «Parameter sz».  
- Учёт SL/TP, закрытие позиций через SELL и проставление `closed_at` в БД.

### 2.2 Замечания

- **Дублирование `notifyFilled`:** см. п. 1.2.  
- **Ручное закрытие #52 (BTCUSDT):** в БД `status = CLOSED_MANUAL`, `realized_pnl = -5`. Позиция корректно исключена из открытых; баланс на бирже может содержать остаточный dust.

---

## 3. Бэктест и эффективность стратегии (Backtest & strategy performance)

### 3.1 Результаты `strategy:backtest-all` (RSI 45/55, период 1000)

| Бот | Return | Total Trades | Win Rate | Total PnL (USDT) |
|-----|--------|--------------|----------|------------------|
| BTCUSDT | -0.03% | 7 | 71.43% | -0.16 |
| ETHUSDT | -0.07% | 5 | 20.00% | -0.59 |
| SOLUSDT | -0.20% | 5 | 40.00% | -1.93 |
| BNBUSDT | -0.02% | 4 | 50.00% | -0.18 |

- Средняя доходность: **-0.08%**, все пары в минусе.  
- Win Rate 45.36% в среднем; у ETHUSDT низкий WR при небольшом числе сделок.

### 3.2 Вывод по бэктесту

- Отрицательная доходность указывает на то, что при текущих параметрах (RSI 45/55, SL/TP, размер позиции) комиссии и убыточные выходы перевешивают прибыльные.  
- Высокий Win Rate по BTC при отрицательном PnL типичен для стратегий с жёстким SL: много «малых побед» и редкие крупные просадки.

---

## 4. Риски и рекомендации (Risks & recommendations)

### 4.1 Технические

1. ~~**Убрать дублирование `notifyFilled`**~~ ✅ Сделано: в `orders:sync` уведомление только при переходе в FILLED.  
2. Продолжать регулярно запускать `orders:sync` и `monitor:system` для контроля согласованности БД и биржи.

### 4.2 Стратегия и параметры

1. **Оптимизация параметров:** перебор RSI/EMA, SL/TP, таймфрейма (например, 4h) на истории; сверка с живой торговлей.  
2. **Учитывать комиссии** в бэктесте явно (taker fee OKX).  
3. По текущему бэктесту **не увеличивать** агрессивность (объём, частоту) без повторной проверки на истории и стрессе.

### 4.3 Операционные

1. Следить за «пылью» (dust) по BTC/ETH/SOL/BNB: при необходимости докупать до минимального лота или конвертировать на бирже.  
2. Heartbeat и мониторинг ошибок в Telegram оставить включёнными.

---

## 5. Краткая сводка (Summary)

| Аспект | Оценка | Комментарий |
|--------|--------|-------------|
| Согласованность данных | ✅ | БД, OKX, Telegram, портфель в целом согласованы |
| Логика BUY/SELL/HOLD | ✅ | Работает по RSI+EMA, без лишних BUY и без min-size ошибок SELL |
| Уведомления Telegram | ✅ | Дубли «ORDER FILLED» убраны (sync нотит только при переходе в FILLED) |
| Бэктест | ❌ | Отрицательная доходность по всем парам |
| Готовность к продакшену | ✅ | Система стабильна; стратегию лучше донастроить по бэктесту и осторожно масштабировать |

---

*Отчёт подготовлен по данным на 2026-01-29. При изменении параметров ботов, стратегии или окружения анализ стоит повторить.*
