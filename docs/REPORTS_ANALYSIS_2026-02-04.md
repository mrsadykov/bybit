# Анализ отчётов (04.02.2026)

## Источники

- Telegram: последние сообщения (запуск ботов, HOLD по всем парам).
- OKX: Order History и Trade Details (CSV).
- SQL: `trades`, `bot_statistics`, `bot_decision_logs`, `btc_quote_trades`.
- Скриншоты: портфель ~126.80 USDT, дашборд OKX 126.82 USDT.

---

## 1. Что в порядке

- **Telegram и логика ботов**  
  4 spot, 2 futures, 1 BTC-quote — все в HOLD. RSI 41–49 (нейтральная зона), цены и EMA близки. Сообщения соответствуют текущему состоянию.

- **Совпадение OKX и БД**  
  Order ID и суммы из OKX (Order History / Trade Details) совпадают с таблицей `trades`. Ручной ордер CONVERT (70 USDT ↔ BTC) в OKX не от бота — так и должно быть.

- **Статистика**  
  `bot_statistics` за 04.02: total_pnl −2.88 USDT за 30 дней, 47 сделок, 19 выигрышных / 28 проигрышных. Совпадает с фактическими сделками в `trades`.

- **Риск-лимиты**  
  02.02 боты 1 и 2 (BTC, ETH) стабильно получали SKIP с причиной `risk_limit`. После исполнения стоп-лосса по BTC снова HOLD. Лимиты срабатывают как задумано.

- **Стоп-лосс**  
  02.02 20:10 в логах: SELL «STOP-LOSS (3.00%)», затем `sell_in_progress`. Этому соответствует сделка id 104 в `trades` (продажа BTC 78 844).

---

## 2. Что исправлено в коде

### 2.1. Статус сделок BTC-quote (PENDING → FILLED)

**Проблема:**  
В `btc_quote_trades` была запись по SOLBTC (order_id 3267451070329856000) со статусом **PENDING** и пустым `filled_at`, тогда как в OKX этот ордер уже **COMPLETE** и есть исполнение в Trade Details.

**Причина:**  
Бот при размещении ордера создаёт сделку со статусом PENDING и дальше не обновляет статус по ответу биржи.

**Сделано:**  
В команду `btc-quote:run` добавлена синхронизация в начале каждого запуска:

- Выбираются все сделки со статусом `PENDING` и непустым `order_id` по активным OKX BTC-quote ботам.
- Для каждой вызывается OKX API `getOrder(symbol, order_id)`.
- Если у ордера состояние `filled`, запись в БД обновляется: `status = FILLED`, `filled_at` проставляется при необходимости.

Файл: `app/Console/Commands/RunBtcQuoteBotsCommand.php`, метод `syncPendingBtcQuoteTrades()`.

**Что сделать вам:**  
При следующем запуске `php artisan btc-quote:run` существующая PENDING-сделка по SOLBTC будет автоматически переведена в FILLED (если ордер на бирже заполнен). Дополнительно вручную ничего делать не нужно.

---

## 3. Рекомендации (без срочных правок)

### 3.1. BTC-quote: EMA в логах решений

В `bot_decision_logs` у записей `btc_quote` поле `ema` часто равно **0**. Если в стратегии BTC-quote используется EMA, стоит проверить расчёт/подстановку EMA при логировании, чтобы в логах было не 0, а фактическое значение (для отладки и анализа).

### 3.2. Стратегия и просадка

- Бэктесты по текущим параметрам (RSI 38/62 и т.п.) дают отрицательную доходность; реальные результаты (total_pnl −2.88 USDT за 30 дней, win rate ~40%) это подтверждают.
- Имеет смысл периодически перезапускать оптимизацию (`strategy:optimize-all` / `strategy:backtest-all-bots`) и при необходимости ужесточать риск: меньше размер позиции, использование `max_losing_streak`, при необходимости временное отключение части ботов до смены режима рынка.

### 3.3. Ручное закрытие (trade id 52)

Сделка с `status = CLOSED_MANUAL` и `realized_pnl = -5` — учтена в статистике корректно. Никаких изменений в коде не требуется.

---

## 4. Краткая сводка

| Проверка              | Статус |
|-----------------------|--------|
| Telegram vs логика    | OK     |
| OKX ↔ БД (trades)     | OK     |
| bot_statistics        | OK     |
| Риск-лимиты / стоп-лосс | OK   |
| btc_quote_trades PENDING | Исправлено (синхронизация в `btc-quote:run`) |
| Рекомендации          | См. п. 3 (EMA в логах, стратегия, риск) |

Итог: **критичных расхождений нет.** Внесено одно изменение: автоматическое обновление статуса PENDING → FILLED для сделок BTC-quote по данным OKX при каждом запуске `btc-quote:run`.
