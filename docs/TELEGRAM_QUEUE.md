# Очередь для Telegram-уведомлений

Уведомления в Telegram можно отправлять через Laravel Queue: команды ботов ставят сообщения в очередь и сразу продолжают работу, а отправкой занимается воркер.

## Включение

В `.env`:

```env
TELEGRAM_QUEUE=true
```

По умолчанию используется драйвер очереди из `QUEUE_CONNECTION` (часто `database`). Таблицы `jobs` и `failed_jobs` создаются миграциями Laravel.

## Запуск воркера очереди

Чтобы сообщения реально отправлялись, должен работать воркер:

```bash
php artisan queue:work
```

В продакшене обычно запускают воркер через Supervisor или systemd и держат его постоянно включённым. Без воркера при `TELEGRAM_QUEUE=true` сообщения будут только накапливаться в таблице `jobs` и не уйдут в Telegram.

## Поведение

- При `TELEGRAM_QUEUE=false` (по умолчанию) отправка выполняется синхронно в том же процессе, что и команда (`bots:run`, `futures:run` и т.д.).
- При `TELEGRAM_QUEUE=true` каждый вызов `TelegramService::sendMessage()` ставит в очередь job `SendTelegramMessageJob`; метод возвращает `true` сразу (успех постановки в очередь). Сама отправка выполняется воркером с 3 попытками и backoff 30 секунд при ошибке.

## Зачем использовать очередь

- Меньше риск таймаута крона при долгом ответе Telegram API.
- Сбои Telegram не блокируют выполнение ботов: решение по сделке принимается, уведомление уйдёт при следующей попытке воркера.
