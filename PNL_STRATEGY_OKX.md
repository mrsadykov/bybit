# Стратегия, PnL и OKX: как всё связано

Кратко: **стратегия** (RSI+EMA, SL/TP) работает **по ценам и сигналам**, а не по PnL. **PnL** мы считаем сами (FIFO, комиссии) для отчётов. С **PnL на OKX** возможны небольшие отличия из‑за формул, округлений и «сегодня» vs «всё время».

---

## 1. Стратегия и PnL

**Стратегия** (покупка/продажа, HOLD) зависит только от:

- RSI, EMA, цена, таймфрейм;
- наличие открытой позиции (пропуск BUY, решение SELL);
- Stop‑Loss / Take‑Profit.

**PnL на это не влияет.** Мы не «подстраиваем» сделки под PnL OKX. Логика корректна, если:

- бот вовремя ставит/снимает ордера;
- `orders:sync` подтягивает статусы и цены с биржи;
- BUY/SELL и SL/TP отражают реальные сделки на OKX.

Итог: **стратегия работает правильно** с точки зрения логики. Вопрос «учёт PnL OKX» относится не к ней, а к **отчётности** (как мы считаем PnL и насколько он совпадает с OKX).

---

## 2. Как мы считаем PnL

При закрытии BUY сделкой SELL (`orders:sync`, логика FIFO):

```
PnL = (цена_продажи × кол-во) − (цена_покупки × кол-во) − комиссия_покупки − комиссия_продажи
```

- **FIFO:** сначала закрываются старые BUY.
- **Комиссии:** учтены и по покупке, и по продаже (пропорционально объёму при частичном закрытии).
- Цены и объёмы берём из наших `trades` (обновляются из OKX при sync).

В БД хранится `realized_pnl` по каждой **закрытой** BUY‑позиции. В дашборде/статистике мы суммируем эти значения.

---

## 3. Почему наш PnL может отличаться от OKX

| Причина | Пояснение |
|--------|------------|
| **Округление** | Разное округление цен, объёмов, комиссий. |
| **Комиссии** | OKX хранит комиссию в базовой валюте (BTC, ETH, …). Мы используем их как есть; конвертация в USDT при расчёте может отличаться от OKX. |
| **«Сегодня» vs «всё время»** | OKX «PnL за сегодня» — только сделки за **текущий день** (по их таймзоне). Мы считаем **все** закрытые позиции по `realized_pnl`. Для сравнения нужно смотреть тот же период. |
| **FIFO / разрез позиций** | Мы закрываем BUY в строгом FIFO. OKX может использовать свою схему (в т.ч. FIFO, но с другими правилами разбиения). |

Поэтому **небольшие расхождения** между нашим суммарным PnL и OKX — нормальны. Крупные отличия имеют смысл проверять по конкретным сделкам.

---

## 4. Что сверять с OKX

1. **Балансы** (USDT, BTC, …) — после sync и загрузки балансов в дашборде они должны совпадать с OKX.
2. **Сделки** — наши `trades` с `order_id` соответствуют Order History / Trade Details на OKX (те же ордера, статусы, цены).
3. **PnL за период** — сравнивать **один и тот же** интервал (день, неделя). Наш «Total PnL» по умолчанию — за всё время; «PnL за сегодня» на OKX — только за день.

---

## 5. Итог

- **Стратегия** завязана на цены и индикаторы, не на PnL. С учётом этого она реализована корректно.
- **PnL** мы считаем сами (FIFO + комиссии). Он используется для отчётов и дашборда.
- **OKX PnL** может немного отличаться из‑за округлений, комиссий и выбора периода. Это не означает ошибку в стратегии.
- Имеет смысл периодически сверять балансы и список сделок с OKX; при больших расхождениях по PnL — разбирать по конкретным ордерам и датам.
