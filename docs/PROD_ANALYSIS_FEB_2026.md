# Анализ прода: дамп БД, OKX, .env — почему нет ордеров с 4 февраля

## 1. Дамп БД `trading_bot (2).sql`

- **Таблицы:** структура и данные по `bot_decision_logs`, `trades`, `trading_bots` и др. соответствуют ожидаемой схеме.
- **Последние сделки в `trades`:**
  - 106: BNB SELL 2026-02-04 10:50:32 (STOP-LOSS)
  - 105: SOL SELL 2026-02-04 02:55:31 (STOP-LOSS)
  - 104: BTC SELL 2026-02-02 14:10:31 (STOP-LOSS)
- **Спот-боты в дампе:** 1 BTC, 2 ETH, 3 SOL (is_active=0, dry_run=1), 4 BNB, 5 ETH 4h. Активные спот: 1, 2, 4, 5.

Ошибок в структуре дампа не найдено.

---

## 2. История ордеров OKX (Order History / Trade Details)

- **Последние ордера по времени:** 2026-02-04 18:50 BNB Sell, 2026-02-04 10:55 SOL Sell — совпадают с последними сделками в БД (по символу и дате).
- Выгрузка по споту (Spot); фьючерсные ордера в этих CSV не видны (если экспорт только по споту).

Несоответствий между OKX и дампом по споту не видно.

---

## 3. Фрагмент .env

Проверено по смыслу и типичным опечаткам:

| Переменная | Значение | Комментарий |
|------------|----------|-------------|
| TRADING_ALERT_* | 10, 3, 50 | Ок |
| TRADING_MAX_OPEN_POSITIONS_TOTAL | 5 | Ок |
| TRADING_EMA_TOLERANCE_* | 1, 3, 25 | Ок |
| FUTURES_* / BTC_QUOTE_* | true, 3, true, 0.001 | Ок |
| TRADING_POSITION_SIZE_MULTIPLIER | 0.5 | Ок |
| TRADING_STOP_LOSS_PERCENT_OVERRIDE | 3 | Ок |
| TRADING_CONSERVATIVE_RSI | false | Ок |
| TRADING_MIN_MINUTES_BETWEEN_OPENS | 60 | Ок |
| TRADING_PAUSE_NEW_OPENS_DAILY_LOSS_USDT | 15 | Ок (в комментарии было 10 — значение 15 осознанное) |
| HEALTH_* | 15, 60 | Ок |
| TRADING_TRAILING_STOP_* | 2, 1 | Ок |
| TRADING_TREND_FILTER_* | true, 50, 0.5 | Ок |
| TRADING_SKIP_BUY_FIRST/LAST_MINUTES | 5, 5 | Ок |

Ошибок в приведённом фрагменте .env нет.

---

## 4. Почему ордеров нет с 4 февраля

По логам решений (`bot_decision_logs`) после 4 февраля:

**Спот (BTC, ETH, BNB, ETH 4h):**  
Почти все записи — **HOLD** с причиной вида «RSI в нейтральной зоне (41–46)». То есть RSI всё время в диапазоне ~38–55: нет условия для BUY (RSI &lt; порога покупки при цене выше EMA) и нет открытых позиций для SELL по сигналу.

**Итог по споту:** с 4 февраля не было ни одного сигнала **BUY**, который прошёл бы фильтры. Причины не в сбое, а в настройках и рынке:

1. **Стратегия:** BUY только при RSI ниже порога (38/45) и цена &gt; EMA. За последние дни RSI по символам держится в нейтральной зоне (38–55), поэтому стратегия выдаёт только HOLD.
2. **Фильтры:** при включённых тренде (TREND_FILTER) и времени (SKIP_BUY_FIRST/LAST_MINUTES=5) часть потенциальных входов отсекается. В сочетании с «нейтральным» RSI это ещё сильнее сокращает число BUY.
3. **Пауза по убытку:** TRADING_PAUSE_NEW_OPENS_DAILY_LOSS_USDT=15 сбрасывается по дням. Если 4 февраля был день с убытком ≥15 USDT, в тот день новые BUY блокировались; в следующие дни — уже нет.

**Фьючерсы:** в логе решений есть записи **BUY** (strategy_buy) по фьючерсам после 4 февраля (например 04.02 19:15, 21:10, 05.02 00:10 и т.д.). Если в проде фьючерсные боты работают с **dry_run=1** (FUTURES_DRY_RUN_DEFAULT=true или dry_run в таблице `futures_bots`), реальные ордера на биржу не отправляются — только симуляция. Тогда отсутствие фьючерсных ордеров в OKX ожидаемо.

---

## 5. Рекомендации

1. **Чтобы снова появлялись спотовые BUY (при желании):**
   - Можно чуть ослабить вход: например, уменьшить **TRADING_SKIP_BUY_FIRST_MINUTES** / **TRADING_SKIP_BUY_LAST_MINUTES** (или отключить, задав пусто) — меньше «запретных» минут в начале/конце свечи.
   - Либо временно ослабить **TRADING_TREND_FILTER_TOLERANCE_PERCENT** (например с 0.5 до 1) или отключить тренд-фильтр — больше шансов входа при текущем RSI. Делать только если осознаёшь рост риска.
   - Либо оставить как есть и считать отсутствие сделок нормальным, пока рынок не даст RSI &lt; порога.

2. **Фьючерсы:** если цель — реальные фьючерсные сделки, проверь в БД и в дашборде, что у нужных фьючерсных ботов **dry_run=0** и что **REAL_TRADING** и ключи OKX позволяют торговать фьючерсами.

3. **Мониторинг:** смотреть **Decision log** в дашборде (или выборку из `bot_decision_logs`): по причинам SKIP/HOLD (trend_filter, time_filter, pause_daily_loss, RSI в нейтральной зоне) видно, почему не было BUY.

4. **Проверка на сервере:**  
   `php artisan bots:run` — в выводе будут текущие RSI/EMA и сигнал (HOLD/BUY/SELL). Если стабильно HOLD, причина та же: условия для BUY не выполняются.

---

## 6. Краткий вывод

- **Ошибок в дампе БД, в приведённом .env и в соответствии OKX ↔ БД не выявлено.**
- **Ордеров нет с 4 февраля по споту** из‑за того, что с этого времени стратегия по споту выдаёт только **HOLD** (RSI в нейтральной зоне 38–55), без сигналов BUY, проходящих все фильтры. Фьючерсные BUY в логе есть; если по ним нет ордеров на бирже — скорее всего фьючерсы в **dry_run**.
