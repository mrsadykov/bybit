# Анализ: ордера OKX, БД, логика и влияние комиссий

## 1. Сверка OKX ↔ БД

**Последние ордера в OKX (Order History):**
- 3313362782148829184 — BNB Sell 2026-02-16 18:25, 0.004 BNB @ 624.7
- 3312487142470131712 — SOL-BTC Buy (btc-quote)
- 3310433449063161856 — BNB Buy 2026-02-15 18:10, 0.004 BNB @ 623.7

**Последние сделки в БД (trades):**
- 108 — SELL BNBUSDT, order_id 3313362782148829184, 2026-02-16 10:25:06
- 107 — BUY BNBUSDT, order_id 3310433449063161856, 2026-02-15 10:10:05

Order ID совпадают. Цены и объёмы в БД соответствуют OKX (0.004008 BNB buy @ 623.7, 0.004004 sell @ 624.7, комиссия на продаже −0.00250130 USDT). Цепочка BUY → SELL (parent_id 108 → 107) корректна.

**Вывод:** учёт покупок/продаж и привязка к ордерам биржи считаются правильно, расхождений нет.

---

## 2. Логика покупки/продажи

- **BUY:** по сигналу стратегии (RSI + EMA), с учётом лимитов (дневной убыток, просадка, кол-во позиций), размера позиции и множителя из конфига.
- **SELL:** по сигналу, стоп-лоссу, тейк-профиту или трейлинг-стопу; объём берётся из фактического баланса монеты (или из позиции в БД).
- В дампе у сделок есть `parent_id` для связи BUY→SELL, `realized_pnl` заполняется при закрытии. Ошибок в логике не видно.

---

## 3. Влияние маленького position_size и комиссий

**Текущие размеры (из БД + множитель 0.5):**
- BTC: 10 × 0.5 = **5 USDT** на сделку  
- ETH 1h/4h: 5 × 0.5 = **2.5 USDT**  
- BNB: 5 × 0.5 = **2.5 USDT**  
- SOL: 10 × 0.5 = **5 USDT**  

**Комиссия OKX (taker):** порядка **0.08–0.10%** с каждой стороны. Круговая: **~0.16–0.20%** от оборота.

**Пример (BNB, последняя пара 107/108):**
- Оборот: ~2.5 USDT на вход и ~2.5 на выход ≈ **5 USDT** за круг.
- Комиссия: 5 × 0.002 ≈ **0.01 USDT** за круг.
- Чтобы выйти «в ноль» после комиссий, движение цены должно быть уже **~0.4%** в плюс только на покрытие комиссий. Небольшой профит (например +0.2% по цене) при таких размерах легко съедается комиссией, и сделка в БД может быть с минимальной или отрицательной прибылью.

**Вывод:** да, при текущих маленьких размерах позиции комиссия съедает значимую часть дохода. Часть убыточных или «плоских» сделок объясняется не ошибкой логики, а тем, что комиссия в процентах от оборота велика относительно размера позиции.

---

## 4. Рекомендации

1. **Увеличивать размер позиции (в разумных пределах)**  
   Например, поднять `position_size` так, чтобы в USDT на сделку было **не 2.5–5, а 15–25 USDT** (с учётом множителя 0.5). Тогда при том же % движения комиссия будет занимать меньшую долю прибыли. Делать только если готов к большему риску на сделку.

2. **Не менять логику подсчёта**  
   Сопоставление с OKX и структура сделок в БД выглядят корректно; менять формулу покупки/продажи или учёт PnL не требуется.

3. **Оставить консервативные лимиты**  
   Ограничения по дневному убытку, просадке и числу позиций уменьшают шанс «словить» много мелких убыточных сделок подряд из-за комиссий.

Итог: считается и покупается/продаётся правильно; часть потерь или отсутствия прибыли связана с маленьким размером позиции и относительно большой долей комиссии — имеет смысл рассмотреть увеличение `position_size` в рамках приемлемого риска.
