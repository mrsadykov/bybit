## План синхронизации данных БД с биржей OKX

### Текущее состояние

**Баланс на бирже (OKX):**
- BTC: **0.00072997**
- USDT: **67.34436658**

**В БД (из дампа):**
- Открытых позиций: **0.00005631 BTC** (только id 46)
- Закрытых с неправильной датой: **~12 позиций** (id 45-34)

### Проблема

**12 позиций (id 45-34) имеют неправильную дату закрытия:**
- Созданы: 2026-01-25 (сегодня)
- Закрыты: 2026-01-13 19:04:42 (12 дней назад!)
- Это логически невозможно

**Эти позиции:**
- В БД помечены как закрытые (`closed_at` установлен)
- Но на бирже BTC все еще есть
- Это объясняет расхождение: 0.00072997 - 0.00005631 = **0.00067366 BTC**

### Анализ истории ордеров из OKX

**SELL ордера из OKX:**
1. **3248521070457331712** (2026-01-25 04:41:43) - SELL 0.00073462 BTC
   - Это SELL id 33 в БД
   - Закрыл позиции id 31-20 (правильно)

2. **3226930834849865728** (2026-01-17 22:53:53) - SELL 0.0001 BTC
   - Это SELL id 7 в БД
   - Закрыл позицию id 6 (правильно)

3. **3215477009521778688** (2026-01-14 00:04:42) - SELL 0.0001 BTC
   - Это SELL id 1 в БД
   - Закрыл позиции id 2, 3 (правильно)

**BUY ордера из OKX:**
- Последний: **3248706674482683904** (2026-01-25 06:10:04) - BUY 0.0001 BTC
- Это соответствует id 46 в БД (открытая позиция)

### Решение

**Проблемные позиции (id 45-34):**
- Созданы 2026-01-25
- Закрыты датой 2026-01-13 19:04:42 (неправильно)
- На бирже BTC все еще есть

**Вариант 1: Позиции не закрыты (рекомендуется)**

Если на бирже BTC есть, значит позиции не закрыты. Нужно убрать `closed_at`:

```sql
-- Убрать closed_at для позиций, созданных после даты закрытия
UPDATE trades
SET closed_at = NULL, realized_pnl = NULL
WHERE trading_bot_id = 1
  AND symbol = 'BTCUSDT'
  AND side = 'BUY'
  AND closed_at = '2026-01-13 19:04:42'
  AND created_at > '2026-01-13 19:04:42';
```

**Вариант 2: Позиции закрыты SELL id 33**

Если позиции закрыты SELL id 33, установить правильную дату:

```sql
-- Установить правильную дату закрытия для позиций, закрытых SELL id 33
UPDATE trades
SET closed_at = '2026-01-25 04:41:43'
WHERE trading_bot_id = 1
  AND symbol = 'BTCUSDT'
  AND side = 'BUY'
  AND closed_at = '2026-01-13 19:04:42'
  AND created_at > '2026-01-13 19:04:42'
  AND id BETWEEN 20 AND 31;  -- Позиции, которые должны быть закрыты SELL id 33
```

### Проверка перед исправлением

**1. Подсчитать количество BTC в проблемных позициях:**

```sql
SELECT SUM(quantity) as total_btc
FROM trades
WHERE trading_bot_id = 1
  AND symbol = 'BTCUSDT'
  AND side = 'BUY'
  AND closed_at = '2026-01-13 19:04:42'
  AND created_at > '2026-01-13 19:04:42';
```

**2. Проверить, какие SELL сделки связаны с этими позициями:**

```sql
SELECT 
    b.id as buy_id,
    b.quantity,
    b.created_at,
    b.closed_at,
    s.id as sell_id,
    s.quantity as sell_quantity,
    s.created_at as sell_created,
    s.filled_at as sell_filled
FROM trades b
LEFT JOIN trades s ON s.parent_id = b.id
WHERE b.trading_bot_id = 1
  AND b.symbol = 'BTCUSDT'
  AND b.side = 'BUY'
  AND b.closed_at = '2026-01-13 19:04:42'
  AND b.created_at > '2026-01-13 19:04:42'
ORDER BY b.id;
```

### Рекомендуемый план действий

1. **Выполнить проверку (SQL запросы выше)**
2. **Если позиции не закрыты (на бирже BTC есть):**
   - Выполнить Вариант 1 (убрать `closed_at`)
3. **Если позиции закрыты:**
   - Выполнить Вариант 2 (установить правильную дату)
4. **Проверить баланс после исправления:**
   ```bash
   php artisan balance:check BTC --exchange=okx
   ```
5. **Запустить синхронизацию:**
   ```bash
   php artisan orders:sync
   ```

### Ожидаемый результат

После исправления:
- Открытых позиций в БД должно быть: **~0.00073 BTC**
- Это должно совпадать с балансом на бирже: **0.00072997 BTC**
- Расхождение должно исчезнуть

### Важно

- Некоторые ордера создавались вручную для проверки функционала
- Нужно убедиться, что исправление не затронет тестовые ордера
- Рекомендуется сделать бэкап БД перед исправлением
