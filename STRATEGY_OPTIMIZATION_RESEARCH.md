# Исследование и оптимизация стратегии RSI + EMA

**Дата:** 2026-01-29  
**Стратегия:** RSI + EMA, BUY при RSI < порог и цена ≥ EMA(1−1%), SELL при RSI > порог и цена ≤ EMA(1+1%). SL/TP по % от цены входа.

---

## 1. Текущая конфигурация

| Параметр | Реальная торговля | Бэктест (backtest-all) |
|----------|-------------------|-------------------------|
| RSI период | из бота (часто 17) | из бота |
| EMA период | из бота (часто 10) | из бота |
| RSI BUY / SELL | **40 / 60** (консервативно) | **45 / 55** |
| EMA допуск | 1% | 1% |
| Stop-Loss / Take-Profit | из бота (напр. 3%/6%, 5%/10%) | из бота |
| Комиссия | — | 0.1% |

Итог последнего `strategy:backtest-all` (period=1000, RSI 45/55): отрицательная доходность по всем парам, Win Rate 20–71%. См. отчёт традиционного анализа.

---

## 2. Команды для оптимизации

### 2.1 Бэктест одного символа

```bash
php artisan strategy:backtest BTCUSDT \
  --timeframe=1h --exchange=okx --period=1000 \
  --rsi-period=17 --ema-period=10 \
  --rsi-buy-threshold=45 --rsi-sell-threshold=55 \
  --position-size=10 --stop-loss=3 --take-profit=6 \
  --fee=0.001
```

Опции `--rsi-buy-threshold` и `--rsi-sell-threshold` перебирайте для подбора порогов.

### 2.2 Бэктест всех ботов (фиксированные 45/55)

```bash
php artisan strategy:backtest-all --period=1000 --exchange=okx
```

Использует параметры каждого бота из БД; RSI-пороги жёстко 45/55.

### 2.3 Оптимизация RSI-порогов по всем ботам (**новое**)

```bash
php artisan strategy:optimize-all --period=1000 --exchange=okx [--output=optimize_results.json]
```

Перебирает комбинации **38/62, 40/60, 42/58, 45/55** для каждого бота, вызывает `strategy:backtest` с остальными параметрами из БД. В конце выводит таблицу результатов и **лучшую пару RSI buy/sell по каждому символу** (по `return_percent`).

Имеет смысл запускать на проде или локально с доступом к OKX (сеть).

### 2.4 Полная оптимизация (RSI period, EMA period, SL, TP)

```bash
php artisan strategy:optimize BTCUSDT \
  --timeframe=1h --exchange=okx --period=500 \
  --rsi-min=14 --rsi-max=21 --rsi-step=7 \
  --ema-min=10 --ema-max=20 --ema-step=5 \
  --sl-values=3,5,7 --tp-values=6,10,14 \
  --position-size=10 --sort-by=pnl
```

**Внимание:** `strategy:optimize` использует **свою** симуляцию с фиксированными RSI 30/70 и без 1% EMA tolerance. Логика отличается от живой стратегии и от `strategy:backtest`. Применять только для грубого перебора RSI/EMA/SL/TP; точечную проверку делать через `strategy:backtest`.

---

## 3. Методика оптимизации

1. **Перебор RSI-порогов (рекомендуется первым шагом)**  
   - Запустить `strategy:optimize-all --period=1000`.  
   - Для каждого символа взять лучшую пару RSI buy/sell по return %.  
   - При необходимости сохранить `--output=...` и провести повторный прогон с `--period=1500` или больше.

2. **Перебор RSI/EMA периодов**  
   - Менять `--rsi-period` и `--ema-period` в `strategy:backtest` (или в ботах) и сравнивать return %, Win Rate, число сделок.  
   - Типичные диапазоны: RSI 14–21, EMA 10–20.

3. **Перебор SL/TP**  
   - Варианты: (2%, 4%), (3%, 6%), (4%, 8%), (5%, 10%).  
   - Ужесточение SL уменьшает макс. просадку, но увеличивает число стоп-аутов. TP выше — меньше сделок, но больше тейк-профитов.  
   - Проверять через `strategy:backtest` с `--stop-loss` и `--take-profit`.

4. **Таймфрейм**  
   - Сравнить 1h и 4h на одних и тех же RSI/EMA/SL/TP. Часто 4h даёт меньше шума и меньше сделок.

5. **Учёт комиссий**  
   - В бэктесте используется `--fee=0.001` (0.1%). Совпадать с taker-комиссией OKX. При иной комиссии — явно передавать `--fee`.

---

## 4. Интерпретация результатов

| Метрика | На что смотреть |
|--------|----------------------------------|
| **Return %** | Основной критерий для выбора параметров. Отрицательный — комиссии и убыточные выходы перевешивают прибыль. |
| **Win Rate** | Высокий WR при отрицательном return типичен при жёстком SL: много маленьких прибылей и редкие крупные убытки. |
| **Total Trades** | Слишком мало сделок — слабая статистика; слишком много — рост влияния комиссий и переторговли. |
| **Total PnL** | Суммарная прибыль/убыток в USDT при стартовом балансе 1000. |

Оптимизацию лучше проводить по **return %** (и при необходимости по PnL), а не только по Win Rate.

---

## 5. Рекомендации по шагам

1. Запустить **`php artisan strategy:optimize-all --period=1000 --exchange=okx`** (на сервере с доступом к OKX).  
2. Выписать лучшие RSI buy/sell по каждому символу из вывода.  
3. Применить их:
   - либо глобально в стратегии (если решите использовать одну пару порогов для всех пар),
   - либо по символу (если будет реализована поддержка разных порогов на бота).  
4. Повторить `strategy:backtest-all` с новыми порогами и по возможности с большим `--period`.  
5. При стабильно положительном return на истории — осторожно тестировать в реале (например, dry-run или малый размер позиции).  
6. При необходимости углубить поиск — перебирать RSI/EMA периоды и SL/TP через `strategy:backtest`, фиксируя лучшие наборы.

---

## 6. Ограничения и риски

- **Переобучение:** Наилучшие параметры на истории могут не повториться в будущем. Желательно проверять на разных периодах и разных рыночных режимах.  
- **Комиссии и проскальзывание:** В бэктесте учитывается только fee; проскальзывание и ликвидность не моделируются.  
- **OKX лимиты:** Ограничение на количество свечей за запрос может сокращать фактический `period`; следовать предупреждениям в выводе команд.

---

---

## 7. Per-bot RSI-пороги (применение результатов)

Добавлены поля **`rsi_buy_threshold`** и **`rsi_sell_threshold`** в таблицу `trading_bots`. Если заданы — стратегия и бэктест используют их; иначе используются дефолты (40/60 в реале, 45/55 в бэктесте).

**Установка рекомендуемых значений одной командой:**

```bash
# Сначала посмотреть, что изменится (без записи в БД):
php artisan strategy:apply-optimize --dry-run

# Применить: BTC 45/55, ETH 40/60, SOL 42/58, BNB 38/62
php artisan strategy:apply-optimize
```

**Ручная настройка:** в UI «Редактировать бота» добавлены поля «RSI порог покупки (BUY)» и «RSI порог продажи (SELL)». Пусто = дефолт. Должно выполняться: RSI SELL > RSI BUY.

---

*Документ обновлён 2026-01-29. Добавлены `strategy:optimize-all`, per-bot RSI в БД/UI и `strategy:apply-optimize`.*
