# Финальные рекомендации по бэктестингу

## Текущая ситуация

### Проблема:
- **Очень мало сделок** (1-3 за 1000 свечей) даже с порогами 45/55
- **Отрицательная доходность** (-0.03%)
- **Низкий Win Rate** (33.33%)

### Что было исправлено:
1. ✅ Пороги обновлены на **50/50** (максимально агрессивные)
2. ✅ Период увеличен до **1000 свечей**
3. ✅ Добавлен вывод порогов RSI в параметры

---

## Почему так мало сделок?

### Причина 1: Двойное условие слишком строгое

**Текущая логика:**
- BUY: `RSI < 50` **И** `цена > EMA`
- SELL: `RSI > 50` **И** `цена < EMA`

**Проблема:** Оба условия должны выполняться одновременно, что случается редко.

**Пример:**
- Если RSI = 45 (ниже 50) и цена = EMA (не выше), то сигнала BUY не будет
- Если RSI = 55 (выше 50) и цена = EMA (не ниже), то сигнала SELL не будет

### Причина 2: Рыночные условия

Если рынок в сильном тренде:
- Восходящий тренд: цена постоянно выше EMA, RSI может быть > 50
  - Сигналов BUY не будет (RSI > 50)
  - Сигналов SELL не будет (цена > EMA, нужно цена < EMA)
- Нисходящий тренд: цена постоянно ниже EMA, RSI может быть < 50
  - Сигналов SELL не будет (RSI < 50)
  - Сигналов BUY не будет (цена < EMA, нужно цена > EMA)

---

## Решения

### Решение 1: Убрать условие EMA (рекомендуется для тестирования)

**Новая логика:**
- BUY: `RSI < 50` (только RSI)
- SELL: `RSI > 50` (только RSI)

**Плюсы:**
- Много сигналов
- Простая логика
- Легко тестировать

**Минусы:**
- Много ложных сигналов
- Не учитывает тренд

**Как применить:**
Обновить `BacktestStrategyCommand.php`:
```php
protected function getSignal(float $rsi, float $ema, float $currentPrice, float $rsiBuyThreshold = 30, float $rsiSellThreshold = 70): string
{
    // Убрать условие EMA для большего количества сигналов
    if ($rsi < $rsiBuyThreshold) {
        return 'BUY';
    }

    if ($rsi > $rsiSellThreshold) {
        return 'SELL';
    }

    return 'HOLD';
}
```

### Решение 2: Сделать условие EMA менее строгим

**Новая логика:**
- BUY: `RSI < 50` **И** `цена >= EMA * 0.99` (цена не ниже EMA более чем на 1%)
- SELL: `RSI > 50` **И** `цена <= EMA * 1.01` (цена не выше EMA более чем на 1%)

**Плюсы:**
- Больше сигналов, чем с текущей логикой
- Все еще учитывает тренд

**Минусы:**
- Сложнее реализовать
- Нужно подбирать коэффициент

### Решение 3: Использовать только EMA (без RSI)

**Новая логика:**
- BUY: `цена > EMA` (цена выше EMA)
- SELL: `цена < EMA` (цена ниже EMA)

**Плюсы:**
- Много сигналов
- Простая логика
- Учитывает тренд

**Минусы:**
- Много ложных сигналов
- Не учитывает перекупленность/перепроданность

### Решение 4: Попробовать другие таймфреймы

**15m (рекомендуется):**
- Больше сигналов
- Быстрее реакция на изменения
- Больше комиссий

**4h:**
- Меньше сигналов, но более надежные
- Медленнее реакция
- Меньше комиссий

---

## Рекомендуемый план действий

### Шаг 1: Протестировать с порогами 50/50

```bash
php artisan strategy:backtest-all --period=1000 --exchange=okx --output=backtest_results_50_50.json
```

**Ожидаемый результат:**
- Больше сделок (если все еще мало - проблема в логике или данных)

### Шаг 2: Если все еще мало сделок - убрать условие EMA

Обновить `getSignal()` метод в `BacktestStrategyCommand.php`:
```php
// Убрать условие EMA
if ($rsi < $rsiBuyThreshold) return 'BUY';
if ($rsi > $rsiSellThreshold) return 'SELL';
```

Запустить снова:
```bash
php artisan strategy:backtest-all --period=1000 --exchange=okx --output=backtest_results_no_ema.json
```

### Шаг 3: Проанализировать результаты

**Если много сделок, но плохие результаты:**
- Вернуться к условию EMA
- Оптимизировать пороги RSI (попробовать 40/60, 35/65)
- Оптимизировать периоды RSI/EMA

**Если все еще мало сделок:**
- Проверить данные (убедиться, что получается 1000 свечей)
- Попробовать другие таймфреймы
- Рассмотреть альтернативные стратегии

### Шаг 4: Оптимизировать параметры

Если получили много сделок, но плохие результаты:
1. Попробовать разные пороги RSI (40/60, 35/65, 45/55)
2. Попробовать разные периоды RSI (14, 17, 21)
3. Попробовать разные периоды EMA (10, 20, 50)
4. Попробовать разные таймфреймы (15m, 1h, 4h)

---

## Важные замечания

1. **Пороги 50/50 очень агрессивны:**
   - Дадут много сигналов
   - Много ложных сигналов
   - Используйте только для тестирования

2. **Убрать условие EMA - радикальное решение:**
   - Даст максимальное количество сигналов
   - Но потеряется логика тренда
   - Используйте только для диагностики

3. **Для реальной торговли:**
   - Используйте более консервативные пороги (40/60)
   - Сохраните условие EMA
   - Начните с маленьких сумм

---

## Следующие команды

```bash
# 1. Тест с порогами 50/50 (текущий код)
php artisan strategy:backtest-all --period=1000 --exchange=okx --output=backtest_results_50_50.json

# 2. Тест без условия EMA (после обновления кода)
php artisan strategy:backtest-all --period=1000 --exchange=okx --output=backtest_results_no_ema.json

# 3. Тест на другом таймфрейме
php artisan strategy:backtest BTCUSDT --timeframe=15m --exchange=okx \
  --period=1000 --rsi-period=17 --ema-period=10 \
  --rsi-buy-threshold=45 --rsi-sell-threshold=55 \
  --position-size=5 --stop-loss=3 --take-profit=6 --json
```

---

## Выводы

1. **Текущая стратегия слишком строгая** - двойное условие (RSI + EMA) дает мало сигналов
2. **Нужно либо упростить логику, либо изменить параметры**
3. **Пороги 50/50 - последняя попытка** - если все еще мало сделок, проблема в логике или данных
4. **Рассмотрите альтернативные стратегии** - возможно, RSI+EMA не подходит для текущих условий

---

**Следующий шаг:** Обновите код на проде и запустите бэктестинг с порогами 50/50. Если все еще мало сделок - обновите логику, убрав условие EMA.
