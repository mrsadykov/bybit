## Финальный анализ данных после выполнения рекомендаций

### Баланс на бирже (OKX) - актуальный

**Из команды `balance:check`:**
- BTC: **0.000729967**
- USDT: **67.344366579588**
- BNB: **0.005634715**
- ETH: **8.93E-7**
- SOL: **6.09E-7**
- Цена BTC: **88789.9 USDT**

### Состояние сделок в БД

**Из скриншота 1 (20 последних BUY сделок):**

**Открытые позиции (closed_at IS NULL):**
- id 46: quantity = 0.00005631, price = 88783.2, created_at = 2026-01-25 06:10:03
- **Всего открытых: 1 позиция = 0.00005631 BTC**

**Закрытые позиции:**
- id 45-32 (14 позиций): closed_at = **2026-01-13 19:04:42** ⚠️
  - Это дата из проблемной SELL сделки id 1
  - Эти позиции были созданы 2026-01-25, но закрыты датой из прошлого!
- id 31-26 (6 позиций): closed_at = 2026-01-25 04:41:43
  - Закрыты SELL сделкой id 33 (корректно)

**Из скриншота 2 (29 закрытых позиций):**

**Группировка по дате закрытия:**
1. **13 позиций** закрыты 2026-01-25 04:41:43 (SELL id 33) ✅
2. **12 позиций** закрыты 2026-01-13 19:04:42 (SELL id 1) ⚠️
3. **1 позиция** закрыта 2026-01-17 17:53:53 (SELL id 7) ✅
4. **1 позиция** закрыта 2026-01-13 18:22:17 (старая) ✅

### Критическая проблема

**12 позиций имеют неправильную дату закрытия:**
- Созданы: 2026-01-25 (сегодня)
- Закрыты: 2026-01-13 19:04:42 (12 дней назад!)
- Это невозможно логически

**Эти позиции:**
- Имеют `closed_at` установлен (считаются закрытыми в БД)
- Но на бирже BTC все еще есть (0.000729967)
- Это объясняет расхождение!

### Расчет расхождения

**В БД:**
- Открытых позиций: 0.00005631 BTC (id 46)
- Закрытых позиций с неправильной датой: ~12 позиций × ~0.000056 = ~0.000672 BTC

**На бирже:**
- BTC: 0.000729967

**Расхождение:**
- 0.000729967 - 0.00005631 = **0.000673657 BTC**
- Это примерно соответствует количеству BTC в 12 позициях с неправильной датой!

### Решение

**Нужно исправить `closed_at` для позиций, закрытых SELL id 1:**

```sql
-- Найти все позиции, закрытые проблемной SELL сделкой id 1
SELECT id, quantity, created_at, closed_at
FROM trades
WHERE trading_bot_id = 1
  AND symbol = 'BTCUSDT'
  AND side = 'BUY'
  AND closed_at = '2026-01-13 19:04:42'
  AND created_at > '2026-01-13 19:04:42';  -- Созданы после даты закрытия
```

**Затем исправить:**

```sql
-- Вариант 1: Убрать closed_at (если позиции еще не закрыты)
UPDATE trades
SET closed_at = NULL, realized_pnl = NULL
WHERE trading_bot_id = 1
  AND symbol = 'BTCUSDT'
  AND side = 'BUY'
  AND closed_at = '2026-01-13 19:04:42'
  AND created_at > '2026-01-13 19:04:42';

-- Вариант 2: Установить правильную дату закрытия (если они действительно закрыты)
-- Нужно найти, когда они были закрыты на самом деле
-- Возможно, они закрыты SELL id 33 (2026-01-25 04:41:43)
```

### Рекомендации

1. **Проверить, какие SELL сделки закрыли эти позиции:**
   ```sql
   SELECT 
       b.id as buy_id,
       b.quantity,
       b.created_at,
       b.closed_at,
       s.id as sell_id,
       s.quantity as sell_quantity,
       s.created_at as sell_created,
       s.filled_at as sell_filled
   FROM trades b
   LEFT JOIN trades s ON s.parent_id = b.id
   WHERE b.trading_bot_id = 1
     AND b.symbol = 'BTCUSDT'
     AND b.side = 'BUY'
     AND b.closed_at = '2026-01-13 19:04:42'
   ORDER BY b.id;
   ```

2. **Если позиции не закрыты, убрать closed_at:**
   ```sql
   UPDATE trades
   SET closed_at = NULL, realized_pnl = NULL
   WHERE trading_bot_id = 1
     AND symbol = 'BTCUSDT'
     AND side = 'BUY'
     AND closed_at = '2026-01-13 19:04:42'
     AND created_at > '2026-01-13 19:04:42';
   ```

3. **Если позиции закрыты SELL id 33, установить правильную дату:**
   ```sql
   UPDATE trades
   SET closed_at = '2026-01-25 04:41:43'
   WHERE trading_bot_id = 1
     AND symbol = 'BTCUSDT'
     AND side = 'BUY'
     AND closed_at = '2026-01-13 19:04:42'
     AND created_at > '2026-01-13 19:04:42'
     AND id IN (
       -- ID позиций, которые должны быть закрыты SELL id 33
       SELECT parent_id FROM trades WHERE id = 33
     );
   ```

### Вывод

- **На бирже: 0.000729967 BTC**
- **В БД (открытых): 0.00005631 BTC**
- **Расхождение: 0.000673657 BTC**
- **Причина: 12 позиций имеют неправильную дату закрытия (2026-01-13 вместо реальной даты)**
- **Решение: Исправить `closed_at` для этих позиций**

### Следующие шаги

1. Выполнить SQL запрос для проверки связи BUY-SELL
2. Определить, закрыты ли позиции на самом деле
3. Исправить `closed_at` в зависимости от результата
4. Проверить баланс после исправления
