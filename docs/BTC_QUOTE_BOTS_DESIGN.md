# Боты с базовой валютой BTC (торговля альтов за BTC)

## 1. Идея и ваше понимание

**Да, вы понимаете верно:**

1. **Сначала накапливаете BTC** — вручную или по плану (DCA / при падении). То есть конвертируете часть USDT в BTC, когда считаете, что BTC дёшев (или просто равномерно).
2. **Потом бот торгует только парами «альт/BTC»** — покупает SOL, ETH, BNB и т.д. **за BTC** и продаёт обратно в BTC. Капитал бота — это ваш баланс в BTC; результат тоже в BTC (или конвертируется в USDT для отчётов).

Итого: **идеально сначала купить BTC (в т.ч. в падении или DCA), затем включить ботов, которые торгуют альтами только за этот BTC.**

---

## 2. Два варианта архитектуры

### Вариант A: Расширить текущие сущности (один тип ботов, ветвление по полю)

| Что | Как |
|-----|-----|
| **Боты** | В таблицу `trading_bots` добавить поле `quote_currency` (`USDT` \| `BTC`). По умолчанию `USDT`. |
| **Символ** | Для USDT как сейчас: `SOLUSDT`, `ETHUSDT`. Для BTC: `SOLBTC`, `ETHBTC` (формат OKX: пара к BTC). |
| **Размер позиции** | Для USDT — сумма в USDT. Для BTC — сумма в BTC (например 0.001). |
| **Баланс** | USDT-боты: `getBalance('USDT')`. BTC-боты: `getBalance('BTC')`. |
| **Сделки** | Та же таблица `trades`: `symbol` = `SOLBTC`, `price` в BTC за 1 SOL, `quantity` в SOL, комиссия и PnL в BTC или конвертация в USDT для дашборда. |
| **Команда** | Одна `bots:run`: внутри ветка по `quote_currency` — разная логика баланса, размера ордера и пар. |

**Плюсы:** минимум новых таблиц и команд, один список ботов в админке.  
**Минусы:** логика USDT и BTC в одном месте, больше условий и риска что-то сломать для текущих ботов.

---

### Вариант B: Отдельные сущности (рекомендуется)

| Что | Как |
|-----|-----|
| **Боты** | Новая таблица `btc_quote_bots`: те же поля по смыслу, что у спот-ботов, но `quote_currency` всегда BTC, `symbol` только пары к BTC (`SOLBTC`, `ETHBTC`, …), `position_size_btc` — размер позиции в BTC. |
| **Сделки** | Новая таблица `btc_quote_trades`: аналог `trades`, но привязан к `btc_quote_bot_id`, `symbol` = SOLBTC и т.д., `price` в BTC, `quantity` в базовой валюте (SOL, ETH), `realized_pnl_btc` (и при желании конверт в USDT для отчётов). |
| **Команда** | Новая команда `btc-quote:run` (или `bots:run-btc-quote`): только боты из `btc_quote_bots`, баланс BTC, ордера по парам SOL-BTC, ETH-BTC и т.д. |
| **Админка** | Отдельный раздел «Боты за BTC»: CRUD для `btc_quote_bots`, список сделок `btc_quote_trades`, статистика в BTC (и при желании в USDT). |

**Плюсы:** чёткое разделение: спот в USDT не трогаем, фьючерсы отдельно, «спот за BTC» — отдельно. Проще тестировать и считать PnL в BTC.  
**Минусы:** ещё одна пара таблиц и один команд/контроллер.

---

## 3. Рекомендация: Вариант B (отдельные сущности)

- Текущие боты (USDT), фьючерсы и «боты за BTC» живут разной жизнью: разный баланс, разная валюта PnL, разный риск.
- Отдельные таблицы и команда упрощают отчёты («всего в BTC» по `btc_quote_trades`) и не затрагивают существующий код спот-ботов.

---

## 4. План реализации (Вариант B)

### 4.1 Миграции

- **`btc_quote_bots`**  
  Поля по аналогии с `trading_bots`:  
  `user_id`, `exchange_account_id`, `symbol` (SOLBTC, ETHBTC, …), `timeframe`, `strategy`, `position_size_btc` (decimal), RSI/EMA/пороги, SL/TP при необходимости, `is_active`, `dry_run`, `last_trade_at`, timestamps.

- **`btc_quote_trades`**  
  По аналогии с `trades`:  
  `btc_quote_bot_id`, `side`, `symbol`, `price` (в BTC), `quantity` (в базовой валюте), `fee`, `fee_currency`, `status`, `order_id`, `filled_at`, `closed_at`, `realized_pnl_btc`, `exchange_response`, timestamps.

### 4.2 Модели

- **`BtcQuoteBot`** — как `TradingBot`, связь с `User`, `ExchangeAccount`, `hasMany(BtcQuoteTrade)`.
- **`BtcQuoteTrade`** — как `Trade`, связь `belongsTo(BtcQuoteBot)`.

### 4.3 Обмен (OKX)

- Пары уже есть: SOL-BTC, ETH-BTC, BNB-BTC и т.д.
- В сервисе OKX (или общем фабрике): метод получения цены и свечей по паре `SOLBTC` (или как OKX именует: `SOL-BTC`), размещение рыночного ордера в этой паре.
- Баланс: `getBalance('BTC')` — сколько BTC доступно для торговли.

### 4.4 Логика команды `btc-quote:run`

1. Выбрать активные `BtcQuoteBot` для нужной биржи (OKX).
2. Для каждого бота: пара из `symbol` (например SOLBTC).
3. Получить свечи по этой паре (тот же таймфрейм), считать RSI/EMA, получить сигнал (BUY/SELL/HOLD) той же стратегией (RSI+EMA).
4. **BUY:** проверить баланс BTC ≥ `position_size_btc`; выставить рыночный ордер на покупку базового актива (SOL, ETH, …) за BTC; объём считать из `position_size_btc` и текущей цены (в BTC).
5. **SELL:** если есть открытая позиция по этому символу (баланс SOL/ETH/… от прошлых BUY), выставить рыночный ордер на продажу в BTC; закрыть позицию, записать сделку, посчитать `realized_pnl_btc`.
6. Уведомления в Telegram — по аналогии с текущими ботами (сигнал, пропуск, исполнение), с пометкой «BTC-quote» и суммой в BTC.

### 4.5 «Изначально купить BTC»

- **Не часть этой фичи:** первый шаг (купить BTC в падении или DCA) делаете вы вручную через биржу или отдельный скрипт/команду.
- Опционально позже можно добавить команду/кнопку «Конвертировать X USDT → BTC» по текущей цене (одноразово или по расписанию). Для MVP достаточно ручной покупки BTC; после появления BTC на балансе вы просто включаете ботов из `btc_quote_bots`.

---

## 5. Кратко по сущностям

| Сущность | Назначение |
|----------|------------|
| **BtcQuoteBot** | Настройки бота: пара (SOLBTC, ETHBTC, …), размер позиции в BTC, RSI/EMA, активен/сухой прогон. |
| **BtcQuoteTrade** | История сделок: BUY/SELL по паре к BTC, объём, цена в BTC, реализованный PnL в BTC. |
| Команда **btc-quote:run** | Запуск только BTC-quote ботов: баланс BTC, ордера в парах к BTC, запись в `btc_quote_trades`. |
| Отдельный раздел в админке | Список ботов за BTC, создание/редактирование, список сделок и сводка в BTC (и при желании в USDT). |

Так вы сохраняете текущие сущности (спот USDT, фьючерсы) без изменений и добавляете отдельный, понятный слой «торговля альтов за BTC» с явным начальным шагом: сначала купить BTC (в идеале в падении), затем запускать этих ботов.
