# ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏

## üìä –°–∏—Ç—É–∞—Ü–∏—è

**–í–∞—à–∏ –±–∞–ª–∞–Ω—Å—ã:**
- ETH: 0.00000089 (–æ—á–µ–Ω—å –º–∞–ª–æ)
- SOL: 0.0000006 (–æ—á–µ–Ω—å –º–∞–ª–æ)

**–í–æ–ø—Ä–æ—Å:** –°–º–æ–∂–µ—Ç –ª–∏ –±–æ—Ç –ø–æ–∫—É–ø–∞—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∏–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏?

---

## ü§ñ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç

### PositionManager —Å—á–∏—Ç–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ë–î:

```php
public function getNetPosition(): float
{
    // –°—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã–µ BUY –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã trades
    $result = $this->bot->trades()
        ->where('side', 'BUY')
        ->where('status', 'FILLED')
        ->whereNull('closed_at') // –¢–æ–ª—å–∫–æ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ BUY –ø–æ–∑–∏—Ü–∏–∏
        ->sum('quantity');
    
    return (float) ($result ?? 0);
}

public function canBuy(): bool
{
    return $this->getNetPosition() <= 0;
}
```

**–í–∞–∂–Ω–æ:** –ë–æ—Ç –ù–ï —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–∏—Ä–∂–∏, –∞ —Å—á–∏—Ç–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ë–î!

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í –ë–î –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ BUY –ø–æ–∑–∏—Ü–∏–∏

**–ï—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å:**
- BUY ETH: 0.001553 (status=FILLED, closed_at=NULL)
- BUY SOL: 0.037391 (status=FILLED, closed_at=NULL)

**–¢–æ–≥–¥–∞:**
- `getNetPosition()` –≤–µ—Ä–Ω–µ—Ç > 0 (–¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –æ—á–µ–Ω—å –º–∞–ª)
- `canBuy()` –≤–µ—Ä–Ω–µ—Ç **FALSE**
- –ë–æ—Ç **–ù–ï —Å–º–æ–∂–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å** ‚ùå

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í –ë–î –ù–ï–¢ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π

**–ï—Å–ª–∏ –≤ –ë–î:**
- –í—Å–µ BUY –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç—ã (closed_at —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- –ò–ª–∏ –Ω–µ—Ç BUY –ø–æ–∑–∏—Ü–∏–π –≤–æ–æ–±—â–µ

**–¢–æ–≥–¥–∞:**
- `getNetPosition()` –≤–µ—Ä–Ω–µ—Ç 0
- `canBuy()` –≤–µ—Ä–Ω–µ—Ç **TRUE**
- –ë–æ—Ç **—Å–º–æ–∂–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å** ‚úÖ

---

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏:**
```bash
php artisan tinker
>>> \App\Models\Trade::where('side', 'BUY')
    ->where('status', 'FILLED')
    ->whereNull('closed_at')
    ->get()
    ->each(function($t) {
        echo "Bot #{$t->trading_bot_id} | {$t->symbol} | qty={$t->quantity} | price=\${$t->price}\n";
    });
>>> exit
```

**–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –æ—á–µ–Ω—å –º–∞–ª):**
```bash
php artisan tinker
>>> // –î–ª—è ETH
>>> \App\Models\Trade::where('symbol', 'ETHUSDT')
    ->where('side', 'BUY')
    ->where('status', 'FILLED')
    ->whereNull('closed_at')
    ->update(['closed_at' => now()]);

>>> // –î–ª—è SOL
>>> \App\Models\Trade::where('symbol', 'SOLUSDT')
    ->where('side', 'BUY')
    ->where('status', 'FILLED')
    ->whereNull('closed_at')
    ->update(['closed_at' => now()]);
>>> exit
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–¥–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

**–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏:**
```bash
# ETH
php artisan trade:sell ETHUSDT 0 --all

# SOL
php artisan trade:sell SOLUSDT 0 --all
```

**–ü–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏:**
- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä–æ—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- `closed_at` –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –ë–æ—Ç —Å–º–æ–∂–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (—É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–¥–∞)

**–ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å PositionManager:**
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—å—à–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.0001)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–∏—Ä–∂–∏ –≤–º–µ—Å—Ç–æ –ë–î

**–ù–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏.**

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î:

```bash
php artisan tinker
>>> \App\Models\Trade::where('side', 'BUY')
    ->where('status', 'FILLED')
    ->whereNull('closed_at')
    ->with('bot')
    ->get()
    ->each(function($t) {
        $bot = $t->bot;
        echo "Bot #{$bot->id} ({$bot->symbol}) | Trade #{$t->id} | qty={$t->quantity} | price=\${$t->price} | date={$t->filled_at}\n";
    });
>>> exit
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å netPosition –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞:

```bash
php artisan tinker
>>> \App\Models\TradingBot::where('is_active', true)->get()->each(function($bot) {
    $pm = new \App\Services\Trading\PositionManager($bot);
    $pos = $pm->getNetPosition();
    $canBuy = $pm->canBuy();
    echo "Bot #{$bot->id} ({$bot->symbol}): netPosition={$pos}, canBuy=" . ($canBuy ? 'YES' : 'NO') . "\n";
});
>>> exit
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å—ã –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ (–º–µ–Ω—å—à–µ –º–∏–Ω–∏–º—É–º–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏):**

1. **–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î –≤—Ä—É—á–Ω—É—é:**
   ```bash
   php artisan tinker
   >>> \App\Models\Trade::where('side', 'BUY')
       ->where('status', 'FILLED')
       ->whereNull('closed_at')
       ->whereIn('symbol', ['ETHUSDT', 'SOLUSDT'])
       ->update(['closed_at' => now(), 'realized_pnl' => 0]);
   >>> exit
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç –º–æ–∂–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å:**
   ```bash
   php artisan bots:run
   ```

3. **–ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –æ—á–∏—Å—Ç–∏—Ç—å –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏:**
   - –û—Å—Ç–∞–≤–∏—Ç—å –∏—Ö –Ω–∞ –±–∏—Ä–∂–µ (–Ω–µ –º–µ—à–∞—é—Ç)
   - –ò–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞—Ç—å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å OKX

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

**–ú–∞–ª–µ–Ω—å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ –±–∏—Ä–∂–µ –ù–ï –º–µ—à–∞—é—Ç –±–æ—Ç—É**, –µ—Å–ª–∏:
- ‚úÖ –í –ë–î –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö BUY –ø–æ–∑–∏—Ü–∏–π (closed_at —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- ‚úÖ `getNetPosition()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0
- ‚úÖ `canBuy()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true

**–ú–∞–ª–µ–Ω—å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –º–µ—à–∞—é—Ç –±–æ—Ç—É**, –µ—Å–ª–∏:
- ‚ùå –í –ë–î –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ BUY –ø–æ–∑–∏—Ü–∏–∏ (closed_at = NULL)
- ‚ùå `getNetPosition()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç > 0
- ‚ùå `canBuy()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–∫—Ä—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î!
