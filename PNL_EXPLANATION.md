# Объяснение логики PnL и закрытия позиций

## 1. Когда позиция считается открытой?

Позиция считается **открытой**, если:
- BUY ордер имеет статус `FILLED`
- `closed_at = NULL` (позиция не закрыта)

## 2. Когда позиция закрывается?

Позиция закрывается (`closed_at` устанавливается) когда:
1. SELL ордер имеет статус `FILLED`
2. SELL ордер связан с BUY через `parent_id`
3. Связанный BUY ордер еще не закрыт

**Важно**: Закрытие происходит автоматически в команде `orders:sync` при синхронизации статусов.

## 3. Как считается PnL?

### Формула PnL:

```
PnL = (sell_price × sell_quantity) - (buy_price × buy_quantity) - buy_fee - sell_fee
```

### Пример расчета:

**Сценарий 1: Прибыльная сделка**

- **BUY**: Купили 0.0001 BTC по цене $50,000, комиссия $0.05
- **SELL**: Продали 0.0001 BTC по цене $51,000, комиссия $0.051

```
PnL = (51,000 × 0.0001) - (50,000 × 0.0001) - 0.05 - 0.051
PnL = 5.1 - 5.0 - 0.05 - 0.051
PnL = -0.001 USDT
```

**Сценарий 2: Убыточная сделка**

- **BUY**: Купили 0.0001 BTC по цене $50,000, комиссия $0.05
- **SELL**: Продали 0.0001 BTC по цене $49,000, комиссия $0.049

```
PnL = (49,000 × 0.0001) - (50,000 × 0.0001) - 0.05 - 0.049
PnL = 4.9 - 5.0 - 0.05 - 0.049
PnL = -0.199 USDT
```

**Важно**: 
- PnL считается только когда позиция **закрывается** (когда BUY получает `closed_at`)
- PnL сохраняется в поле `realized_pnl` у **BUY ордера**
- PnL считается **после** закрытия позиции, не до

## 4. Что делать, если позиция не закрывается?

Если позиция уже продана на бирже, но в дашборде она все еще показывается как открытая:

1. **Проверьте, синхронизирован ли SELL ордер:**
   ```bash
   php artisan orders:sync
   ```

2. **Проверьте, есть ли у SELL ордера `parent_id`:**
   - SELL ордер должен быть связан с BUY через `parent_id`
   - Если связи нет, используйте `trades:recover` для восстановления связей

3. **Проверьте статус SELL ордера:**
   - SELL ордер должен иметь статус `FILLED`
   - Если статус не `FILLED`, синхронизируйте через `orders:sync`

## 5. Где происходит расчет PnL?

PnL рассчитывается в двух местах:

1. **`SyncOrdersCommand.php`** (строки 196-201):
   - Когда SELL ордер синхронизируется и имеет статус `FILLED`
   - Формула: `(sell_price × sell_quantity) - (buy_price × buy_quantity) - buy_fee - sell_fee`

2. **`RecoverTradesCommand.php`** (строки 324-329):
   - При восстановлении ордеров из истории биржи
   - Учитывает несколько SELL ордеров, связанных с одним BUY
   - Формула: `сумма(всех sell_price × sell_quantity) - (buy_price × buy_quantity) - buy_fee - сумма(всех sell_fee)`

## 6. Структура данных

- **BUY ордер**: 
  - `closed_at = NULL` → позиция открыта
  - `closed_at != NULL` → позиция закрыта
  - `realized_pnl` → PnL после закрытия позиции

- **SELL ордер**:
  - `parent_id` → ID связанного BUY ордера
  - `status = FILLED` → ордер исполнен
