# Обсуждение архитектуры: Хранение ордеров в БД

## Вопросы

1. Насколько грамотно синхронизировать позицию с балансом?
2. Есть ли смысл хранить все ордера в БД?

## Анализ текущей архитектуры

### Что хранится в БД (таблица `trades`):

- Все ордера (BUY и SELL)
- Статусы ордеров (PENDING, SENT, FILLED, etc.)
- Цены, количества, комиссии
- PnL (прибыль/убыток) для закрытых позиций
- Связи между BUY и SELL (parent_id)

### Как используется:

1. **PositionManager::getNetPosition()** - расчет позиции из БД
2. **SyncOrdersCommand** - синхронизация статусов и расчет PnL
3. **RunTradingBotsCommand** - проверка можно ли купить/продать

## Проблемы текущего подхода

### ❌ Проблема 1: API ограничения
- Bybit API возвращает только ордера за 7 дней
- Старые ордера недоступны
- Невозможно восстановить полную историю

### ❌ Проблема 2: Дублирование данных
- Данные уже есть на бирже
- Нужно постоянно синхронизировать
- Риск рассинхронизации

### ❌ Проблема 3: Усложнение
- Нужно хранить историю
- Нужно синхронизировать статусы
- Нужно обрабатывать ошибки синхронизации

## Альтернативные подходы

### Подход 1: Использовать только баланс (упрощенный)

**Идея:**
- НЕ хранить историю ордеров в БД
- Использовать баланс биржи для расчета позиции
- Хранить только активные ордера (PENDING, SENT)

**Плюсы:**
- ✅ Простота
- ✅ Нет проблем с синхронизацией
- ✅ Работает с любым возрастом ордеров

**Минусы:**
- ❌ Нет истории для анализа
- ❌ Нет точного расчета PnL (можно только из баланса)
- ❌ Нет понимания средних цен покупки

**Когда использовать:**
- Простые стратегии
- Не нужна детальная аналитика
- Приоритет - простота

### Подход 2: Гибридный (рекомендуется)

**Идея:**
- Хранить только **активные** ордера (PENDING, SENT, PARTIALLY_FILLED)
- Использовать **баланс** для расчета позиции
- После закрытия позиции (BUY -> SELL) - сохранять только итоги (PnL)
- История для анализа хранится отдельно (опционально)

**Плюсы:**
- ✅ Простота + функциональность
- ✅ Нет проблем со старыми ордерами
- ✅ Есть PnL для закрытых позиций
- ✅ Меньше данных в БД

**Минусы:**
- ⚠️ Нет полной истории каждого ордера
- ⚠️ Нужно правильно обрабатывать закрытие позиций

**Когда использовать:**
- Большинство торговых ботов
- Нужен PnL, но не нужна детальная история
- Баланс между простотой и функциональностью

### Подход 3: Полная история (текущий)

**Идея:**
- Хранить ВСЕ ордера в БД
- Синхронизировать с биржей
- Восстанавливать через API когда возможно

**Плюсы:**
- ✅ Полная история
- ✅ Детальная аналитика
- ✅ Точный расчет PnL
- ✅ Понимание всех сделок

**Минусы:**
- ❌ Проблемы с API ограничениями
- ❌ Сложность синхронизации
- ❌ Риск рассинхронизации
- ❌ Больше данных в БД

**Когда использовать:**
- Нужна полная аналитика
- Важна точность истории
- Можно справиться с ограничениями API

## Рекомендации

### Для вашего случая (Bybit, ордера старше 7 дней):

**Рекомендую: Гибридный подход**

1. **Использовать баланс для позиции:**
   ```php
   // Вместо PositionManager::getNetPosition() из БД
   // Использовать баланс монеты с биржи
   $balance = $bybit->getBalance('BTC');
   ```

2. **Хранить только активные ордера:**
   - PENDING, SENT, PARTIALLY_FILLED
   - После FILLED - удалять или архивировать

3. **После закрытия позиции сохранять только итоги:**
   - Создать таблицу `closed_positions` (BUY + SELL = PnL)
   - Или хранить только последнюю пару BUY/SELL

### Реализация гибридного подхода:

#### Вариант A: Использовать баланс + хранить активные ордера

```php
class PositionManager
{
    public function getNetPosition(): float
    {
        // Используем баланс биржи, а не БД
        $bybit = new BybitService($this->bot->exchangeAccount);
        $baseCoin = str_replace('USDT', '', $this->bot->symbol);
        return $bybit->getBalance($baseCoin);
    }
    
    public function hasActiveOrders(): bool
    {
        // Проверяем есть ли активные ордера
        return $this->bot->trades()
            ->whereIn('status', ['PENDING', 'SENT', 'PARTIALLY_FILLED'])
            ->exists();
    }
}
```

#### Вариант B: Использовать баланс + синтетическая начальная позиция

```php
// Один раз при старте
php artisan position:sync-from-balance --bot=20 --force

// Затем использовать баланс
class PositionManager
{
    public function getNetPosition(): float
    {
        $bybit = new BybitService($this->bot->exchangeAccount);
        $baseCoin = str_replace('USDT', '', $this->bot->symbol);
        return $bybit->getBalance($baseCoin);
    }
}
```

## Вывод

### Вопрос 1: Насколько грамотно синхронизировать позицию с балансом?

**Ответ: ОЧЕНЬ грамотно!** Это правильный подход для торговых ботов.

**Преимущества:**
- Источник истины - биржа (баланс всегда актуален)
- Нет проблем с синхронизацией истории
- Работает независимо от возраста ордеров
- Проще и надежнее

### Вопрос 2: Есть ли смысл хранить все ордера в БД?

**Ответ: Зависит от целей**

**НЕ нужно хранить:**
- ✅ Все старые ордера (дублируют данные биржи)
- ✅ Полную историю (если не нужна аналитика)

**НУЖНО хранить:**
- ✅ Активные ордера (для отслеживания статуса)
- ✅ Закрытые позиции (PnL)
- ✅ История только для анализа (опционально)

**Рекомендация:**
1. Использовать баланс для позиции
2. Хранить только активные ордера
3. После закрытия - сохранять только итоги (PnL)
4. Полную историю получать с биржи когда нужно

## Следующие шаги

1. Модифицировать `PositionManager` для использования баланса
2. Очистить старые завершенные ордера
3. Добавить таблицу `closed_positions` для PnL (опционально)
4. Обновить логику работы с позициями
