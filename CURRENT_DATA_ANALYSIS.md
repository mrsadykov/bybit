## Анализ текущих данных

### Данные из таблицы `trades`

**BUY сделки для BTCUSDT:**
- Количество открытых BUY позиций: 13 (id 34-46)
- Все статусы: `FILLED`
- Все `parent_id`: `NULL` (не закрыты SELL сделками)
- Все `trading_bot_id`: `1`
- Период: 2026-01-25 05:00:04 - 06:10:03
- Комиссия: -0.00000006 BTC на каждую сделку

**Примерные количества:**
- Каждая сделка: ~5.618E-5 - 5.631E-5 BTC
- Общее количество в БД (примерно): 13 × 5.625E-5 = **0.00073125 BTC**

### Данные с биржи (OKX)

**Из скриншота "Балансы аккаунтов":**
- BTC: **0.00067371**
- USDT: **72.34374857**
- Общий баланс: **137.11 USDT**

**Из скриншота "Активы":**
- BTC: **0.00072996**
- USDT: **67,34436657** (67.34)
- BTC PnL: -¥0,16 (-0,25%) - убыток

### Сравнение

| Источник | BTC баланс | USDT баланс | Расхождение BTC |
|----------|-----------|-------------|-----------------|
| БД (примерно) | 0.00073125 | - | - |
| Биржа (балансы) | 0.00067371 | 72.34 | -0.00005754 |
| Биржа (активы) | 0.00072996 | 67.34 | -0.00000129 |

### Анализ расхождений

1. **BTC баланс:**
   - БД (примерно): 0.00073125 BTC
   - Биржа (балансы): 0.00067371 BTC
   - Биржа (активы): 0.00072996 BTC
   - **Расхождение между БД и биржей (балансы): ~0.00005754 BTC (~5.1 USDT)**
   - **Расхождение между БД и биржей (активы): ~0.00000129 BTC (~0.11 USDT)**

2. **USDT баланс:**
   - Биржа (балансы): 72.34 USDT
   - Биржа (активы): 67.34 USDT
   - **Расхождение: ~5 USDT**

### Возможные причины расхождений

1. **Разное время обновления:**
   - Скриншоты могли быть сделаны в разное время
   - Балансы обновляются в реальном времени
   - БД обновляется при синхронизации ордеров

2. **Несинхронизированные SELL сделки:**
   - Возможно, есть SELL сделки, которые еще не синхронизированы
   - Или SELL сделки, которые закрыли часть позиций, но `closed_at` еще не обновлен

3. **Комиссии:**
   - Комиссии вычитаются из баланса
   - В БД комиссии учитываются отдельно

4. **Округление:**
   - Разные источники могут округлять по-разному
   - Биржа может показывать доступный баланс vs общий баланс

### Рекомендации

1. **Проверить SELL сделки:**
   ```sql
   SELECT id, side, quantity, price, status, created_at, filled_at, parent_id
   FROM trades
   WHERE symbol = 'BTCUSDT' AND side = 'SELL'
   ORDER BY id DESC
   LIMIT 10;
   ```

2. **Проверить закрытые позиции:**
   ```sql
   SELECT id, quantity, price, closed_at, realized_pnl
   FROM trades
   WHERE symbol = 'BTCUSDT' 
     AND side = 'BUY'
     AND closed_at IS NOT NULL
   ORDER BY closed_at DESC
   LIMIT 10;
   ```

3. **Подсчитать точное количество BTC в БД:**
   ```sql
   SELECT SUM(quantity) as total_btc
   FROM trades
   WHERE trading_bot_id = 1
     AND symbol = 'BTCUSDT'
     AND side = 'BUY'
     AND status = 'FILLED'
     AND closed_at IS NULL;
   ```

4. **Синхронизировать ордера:**
   ```bash
   php artisan orders:sync
   ```

5. **Проверить баланс на бирже:**
   ```bash
   php artisan balance:check BTC --exchange=okx
   ```

### Вывод

- **13 открытых BUY позиций** в БД для BTCUSDT
- **Расхождение BTC:** ~0.00005754 BTC (балансы) или ~0.00000129 BTC (активы)
- **Расхождение USDT:** ~5 USDT между разными источниками

**Рекомендация:** Выполнить синхронизацию ордеров и проверить SELL сделки, чтобы убедиться, что все позиции правильно закрыты.
