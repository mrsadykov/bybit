# Донастройка стратегии RSI+EMA

Краткая инструкция по включению «глубокой перепроданности» и опциональной подстройке периодов по ботам.

---

## 1. Включить «глубокую перепроданность» (рекомендуется)

При **очень низком RSI** (ниже порога) стратегия разрешает BUY, даже если цена чуть **ниже** EMA (в обычном режиме BUY только при цена ≥ EMA).

**На сервере** в `.env` добавь (или раскомментируй):

```env
TRADING_RSI_DEEP_OVERSOLD=28
TRADING_EMA_TOLERANCE_DEEP_PERCENT=2
```

- **TRADING_RSI_DEEP_OVERSOLD=28** — при RSI < 28 считаем «глубокой перепроданностью».
- **TRADING_EMA_TOLERANCE_DEEP_PERCENT=2** — в этом случае разрешаем цену до **2% ниже** EMA для BUY.

После изменений:

```bash
php artisan config:clear
```

Эффект: больше входов по SOL/BNB, когда RSI очень низкий (16–28), а цена чуть под EMA. Риск: больше входов в даунтренде — наблюдай 1–2 недели. При желании можно сначала поставить 3% или RSI 25.

---

## 2. Опционально: период EMA по боту (SOL/BNB)

Более длинная EMA (15–20) даёт меньше ложных входов на волатильных парах.

**Через tinker** (подставь свои ID ботов):

```bash
php artisan tinker
```

```php
// SOLUSDT — бот #3 (проверь ID в админке)
$bot = \App\Models\TradingBot::find(3);
$bot->ema_period = 15;
$bot->save();

// BNBUSDT — бот #4
$bot = \App\Models\TradingBot::find(4);
$bot->ema_period = 15;
$bot->save();
```

Или через веб: **Trading Bots** → редактирование бота → поле **EMA period** (если есть в форме).

---

## 3. Пороги RSI по боту (по желанию)

В форме редактирования бота можно задать:

- **RSI buy threshold** — например 35–38 (строже вход).
- **RSI sell threshold** — например 55–58 (раньше выход).

Дефолт 40/60; для убыточных пар можно попробовать 35/58.

---

## 4. Проверка

После включения глубокой перепроданности в логах Telegram при низком RSI и цене чуть ниже EMA может появиться **BUY** вместо **HOLD**. Следи за сделками 1–2 недели, при необходимости уменьши `TRADING_EMA_TOLERANCE_DEEP_PERCENT` (например до 1) или отключи переменные.

---

## 5. Гарантированная прибыль и что улучшить

**Гарантированной прибыли на истории нет:** при любых RSI-порогах бэктест по текущим данным даёт отрицательный или околонулевой результат. Рынок меняется, прошлая доходность не гарантирует будущую.

Что можно сделать для снижения риска и повышения устойчивости:

- **Применять «наименее плохие» пороги** — после `strategy:optimize-all` выполнить `php artisan strategy:apply-optimize` (spot + btc-quote 40/60).
- **Уменьшить размер позиции** — меньше просадка при той же логике.
- **Стоп-лосс и тейк-профит** — ограничивают убыток по сделке и фиксируют часть прибыли (уже есть для spot/futures).
- **Длинный бэктест** — `--period=1000` и несколько таймфреймов; смотреть на стабильность, а не только на один прогон.
- **Меньше пар или пауза** — отключить самые убыточные боты до смены режима рынка или доработки стратегии.

---

## 6. Снижение риска через .env (п.1–4)

В коде добавлены четыре опции, которые включаются через `.env`. Работают для **spot**, **futures** и **btc-quote** (где применимо).

### 1) Множитель размера позиции

```env
TRADING_POSITION_SIZE_MULTIPLIER=0.5
```

- `1` (по умолчанию) — размер из настроек бота без изменений.
- `0.5` — все боты торгуют **половинным** размером (spot: USDT, futures: USDT маржи, btc-quote: BTC).
- Уменьшает просадку при той же логике входа/выхода.

### 2) Глобальный стоп-лосс (ужесточение)

```env
TRADING_STOP_LOSS_PERCENT_OVERRIDE=2
```

- Если задан — **подменяет** значение стоп-лосса у всех спот-ботов (в процентах).
- Например `2` — закрывать позицию при падении цены на 2% от цены входа (вместо 3–5% в боте).
- Не задан (пусто) — используется стоп-лосс из настроек каждого бота.

### 3) Реже торговать

**Консервативные RSI 35/65:**

```env
TRADING_CONSERVATIVE_RSI=true
```

- При `true` для расчёта сигнала используются пороги **35** (покупка) и **65** (продажа) вместо порогов из бота.
- Меньше сделок, входы только при более выраженной перепроданности.

**Кулдаун между открытиями:**

```env
TRADING_MIN_MINUTES_BETWEEN_OPENS=60
```

- Минимальный интервал в **минутах** между двумя открытиями позиции **одним и тем же ботом**.
- Например `60` — не открывать новую позицию по этому боту, если предыдущее открытие было меньше 60 минут назад.
- Не задан (пусто) — кулдаун не применяется.

### 4) Пауза новых открытий при дневном убытке

```env
TRADING_PAUSE_NEW_OPENS_DAILY_LOSS_USDT=10
```

- Если реализованный PnL **за сегодня** по соответствующему типу ботов (spot / futures / btc-quote) меньше или равен **-10 USDT**, новые **BUY** не выставляются до конца дня.
- Закрытие по стоп-лоссу, тейк-профиту и по сигналу SELL продолжает работать.
- Для btc-quote дневной PnL переводится в USDT по текущему курсу BTC.
- Не задан (пусто) — пауза не включается.

После изменений `.env` выполни:

```bash
php artisan config:clear
```

---

## 7. Трейлинг-стоп (спот)

Трейлинг-стоп фиксирует прибыль при откате цены от **максимума с момента входа**: после роста цены при падении на N% от этого максимума позиция закрывается.

**В `.env`:**

```env
TRADING_TRAILING_STOP_PERCENT=2
TRADING_TRAILING_STOP_ACTIVATION_PERCENT=1
```

- **TRADING_TRAILING_STOP_PERCENT=2** — продавать, когда цена откатила на **2%** от максимума, достигнутого после входа.
- **TRADING_TRAILING_STOP_ACTIVATION_PERCENT=1** — начинать отслеживать максимум только после роста цены на **1%** от цены входа (до этого работают только обычные SL/TP). Если поставить `0`, трейлинг активен с самого входа.

**Порядок срабатывания:** сначала проверяется стоп-лосс (пол), затем тейк-профит, затем трейлинг-стоп. Трейлинг помогает зафиксировать часть прибыли при откате вместо того, чтобы ждать жёсткого TP или отдавать в минус по SL.

**Миграция:** один раз выполни `php artisan migrate` (добавляется поле `trailing_high_price` в таблицу `trades`).

---

## 8. Фильтр тренда по длинной EMA (спот)

Не открывать лонг (BUY), если цена **ниже длинной EMA** — меньше входов против тренда.

**В `.env`:**

```env
TRADING_TREND_FILTER_ENABLED=true
TRADING_TREND_FILTER_EMA_PERIOD=50
TRADING_TREND_FILTER_TOLERANCE_PERCENT=0
```

- **TRADING_TREND_FILTER_ENABLED=true** — включить фильтр.
- **TRADING_TREND_FILTER_EMA_PERIOD=50** — период длинной EMA (50 или 200). При 200 запрашивается больше свечей (250).
- **TRADING_TREND_FILTER_TOLERANCE_PERCENT=0** — BUY только если цена **выше** длинной EMA. Если задать, например, 0.5 — разрешить цену до 0.5% ниже EMA.

При срабатывании фильтра в логах и в Decision Log будет причина `trend_filter` (BUY пропущен: цена ниже длинной EMA).

---

## 9. Фильтр по объёму (спот)

Разрешать BUY только когда **объём последней свечи не ниже среднего** за выбранный период — меньше входов при слабом объёме (без подтверждения движения).

**В `.env`:**

```env
TRADING_VOLUME_FILTER_ENABLED=true
TRADING_VOLUME_FILTER_PERIOD=20
TRADING_VOLUME_FILTER_MIN_RATIO=1.0
```

- **TRADING_VOLUME_FILTER_ENABLED=true** — включить фильтр.
- **TRADING_VOLUME_FILTER_PERIOD=20** — средний объём считается по последним 20 свечам.
- **TRADING_VOLUME_FILTER_MIN_RATIO=1.0** — BUY только если объём последней свечи **≥** среднего. При значении 1.2 — только если объём не меньше 120% от среднего.

Используется объём из ответа биржи (OKX/Bybit, индекс 5 в свече). При срабатывании в логах и Decision Log будет причина `volume_filter`.

---

## 10. Бэктест и оптимизация с фильтрами и длинным периодом

Чтобы **оценить влияние фильтров тренда и объёма** и проверить стратегию на большем объёме данных:

### Бэктест одного символа с фильтрами

```bash
php artisan strategy:backtest BTCUSDT --timeframe=1h --period=500 --trend-filter --trend-ema-period=50 --volume-filter --volume-period=20
```

Опции:
- `--trend-filter` — BUY только если цена выше длинной EMA.
- `--trend-ema-period=50` (или 200).
- `--trend-tolerance=0` — допуск в % ниже EMA (0 = строго выше).
- `--volume-filter` — BUY только если объём последней свечи ≥ среднего.
- `--volume-period=20` и `--volume-min-ratio=1.0`.

### Бэктест всех ботов (фильтры из .env)

При включённых в `.env` `TRADING_TREND_FILTER_ENABLED` и/или `TRADING_VOLUME_FILTER_ENABLED` команда `strategy:backtest-all` автоматически передаёт эти фильтры в бэктест.

```bash
php artisan strategy:backtest-all --period=1000
```

### Оптимизация RSI с фильтрами и большим периодом

```bash
# Больше свечей для статистики
php artisan strategy:optimize-all --period=1500

# С фильтром тренда (параметры из config/trading)
php artisan strategy:optimize-all --period=1000 --trend-filter

# С обоими фильтрами
php artisan strategy:optimize-all --period=1000 --trend-filter --volume-filter

# Другой таймфрейм для всех ботов (если нужно сравнить 4h)
php artisan strategy:optimize-all --period=500 --timeframe=4h
```

Результаты покажут, улучшают ли фильтры доходность на истории (меньше сделок, но выше win rate или меньший минус).
